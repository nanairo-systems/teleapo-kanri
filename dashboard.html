<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📞</text></svg>">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ダッシュボード - テレアポ顧客管理</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<nav class="navbar">
  <div class="navbar-inner">
    <a href="index.html" class="navbar-brand"><span class="icon">📞</span>テレアポ顧客管理</a>
    <button class="hamburger" id="hamburger"><span></span><span></span><span></span></button>
    <ul class="navbar-nav" id="navMenu">
      <li><a href="index.html">🏠 ホーム</a></li>
      <li><a href="dashboard.html" class="active">📊 ダッシュボード</a></li>
      <li><a href="import.html">📥 インポート</a></li>
      <li id="navSettingsLi"><a href="settings.html">⚙️ 設定</a></li>
      <li class="nav-user" id="navUserInfo"></li>
      <li><button class="btn-logout" onclick="logout()">ログアウト</button></li>
    </ul>
  </div>
</nav>

<div class="loading-overlay" id="loading"><div class="spinner"></div></div>
<div class="toast-container" id="toastContainer"></div>

<div class="container">
  <div class="page-header">
    <h1>📊 ダッシュボード</h1>
    <p>架電実績の集計・分析</p>
  </div>

  <div class="controls">
    <label>期間：</label>
    <input type="date" id="dateFrom">
    <span>〜</span>
    <input type="date" id="dateTo">
    <select id="bizFilter"><option value="">全業務</option></select>
    <select id="opFilter"><option value="">全担当者</option></select>
    <button class="btn btn-primary btn-sm" onclick="loadDashboard()">更新</button>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('overview')">📋 全体</button>
    <button class="tab-btn" onclick="switchTab('personal')">👤 個人別</button>
    <button class="tab-btn" onclick="switchTab('business')">🏢 業務別</button>
  </div>

  <!-- 全体タブ -->
  <div class="tab-panel active" id="tab-overview">
    <div class="kpi-grid" id="kpiOverview"></div>
    <div class="chart-row">
      <div class="chart-card"><h3>日別架電数</h3><canvas id="chartDailyOverview"></canvas></div>
      <div class="chart-card"><h3>結果タグ内訳</h3><canvas id="chartResultTags"></canvas></div>
    </div>
    <h3 style="margin:16px 0 8px;font-size:15px;">担当者別 実績テーブル</h3>
    <table class="data-table" id="tableOperators">
      <thead><tr><th>担当者</th><th>架電数</th><th>通話数</th><th>アポ数</th><th>通話率</th><th>アポ率</th><th>平均差</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 個人別タブ -->
  <div class="tab-panel" id="tab-personal">
    <div class="kpi-grid" id="kpiPersonal"></div>
    <div class="chart-row">
      <div class="chart-card"><h3>日別推移</h3><canvas id="chartDailyPersonal"></canvas></div>
      <div class="chart-card"><h3>業務別内訳</h3><canvas id="chartBizPersonal"></canvas></div>
    </div>
    <div class="chart-row">
      <div class="chart-card"><h3>結果タグ内訳</h3><canvas id="chartTagPersonal"></canvas></div>
      <div class="chart-card"><h3>顧客タグ傾向</h3><canvas id="chartCustTagPersonal"></canvas></div>
    </div>
  </div>

  <!-- 業務別タブ -->
  <div class="tab-panel" id="tab-business">
    <div class="kpi-grid" id="kpiBusiness"></div>
    <div class="chart-row">
      <div class="chart-card"><h3>担当者比較</h3><canvas id="chartOpBusiness"></canvas></div>
      <div class="chart-card"><h3>結果タグ傾向</h3><canvas id="chartTagBusiness"></canvas></div>
    </div>
    <h3 style="margin:16px 0 8px;font-size:15px;">進捗テーブル</h3>
    <table class="data-table" id="tableBizProgress">
      <thead><tr><th>業務</th><th>総顧客</th><th>架電済</th><th>未架電</th><th>アポ数</th><th>進捗率</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase-api.js"></script>
<script>
  (function() {
    const a = JSON.parse(localStorage.getItem('authSession') || 'null');
    if (!a || Date.now() > a.expiry) { localStorage.removeItem('authSession'); location.replace('login.html'); }
  })();
  function logout() { if (confirm('ログアウトしますか？')) { localStorage.removeItem('authSession'); location.href = 'login.html'; } }

  const CONNECT_RESULTS = ['対応あり','担当者対応','折り返し待ち'];
  const APPO_TAGS = ['アポ済み','アポ獲得'];
  let dashData = { customers:[], calls:[], operators:[], businesses:[] };
  let charts = {};

  function switchTab(id) {
    document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active', b.textContent.includes(
      id === 'overview' ? '全体' : id === 'personal' ? '個人' : '業務')));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === `tab-${id}`));
  }

  function destroyCharts() {
    Object.values(charts).forEach(c => { try { c.destroy(); } catch(e){} });
    charts = {};
  }

  function getFilteredCalls() {
    let calls = dashData.calls;
    const biz = document.getElementById('bizFilter').value;
    const op = document.getElementById('opFilter').value;
    if (biz) {
      const bizCustIds = new Set(dashData.customers.filter(c => c.businessId === biz).map(c => c.id));
      calls = calls.filter(c => bizCustIds.has(c.customerId));
    }
    if (op) calls = calls.filter(c => c.operator === op);
    return calls;
  }

  function getFilteredCustomers() {
    const biz = document.getElementById('bizFilter').value;
    return biz ? dashData.customers.filter(c => c.businessId === biz) : dashData.customers;
  }

  function pct(a, b) { return b === 0 ? '0%' : (a / b * 100).toFixed(1) + '%'; }

  function isConnect(result) { return CONNECT_RESULTS.some(r => (result || '').includes(r)); }
  function isAppo(result) { return APPO_TAGS.some(r => (result || '').includes(r)); }

  function renderOverview() {
    const calls = getFilteredCalls();
    const total = calls.length;
    const connected = calls.filter(c => isConnect(c.result)).length;
    const appos = calls.filter(c => isAppo(c.result)).length;
    const customers = getFilteredCustomers();
    const calledCust = customers.filter(c => c.callCount > 0).length;

    document.getElementById('kpiOverview').innerHTML = [
      kpi('架電数', total, ''),
      kpi('通話数', connected, pct(connected, total)),
      kpi('アポ数', appos, pct(appos, total)),
      kpi('顧客数', customers.length, `架電済 ${calledCust}`),
    ].join('');

    const daily = groupByDate(calls);
    charts.dailyOverview = lineChart('chartDailyOverview', Object.keys(daily), Object.values(daily), '架電数');

    const tagCounts = {};
    calls.forEach(c => { const r = c.result || '未設定'; tagCounts[r] = (tagCounts[r] || 0) + 1; });
    charts.resultTags = pieChart('chartResultTags', Object.keys(tagCounts), Object.values(tagCounts));

    const opMap = {};
    calls.forEach(c => {
      const op = c.operator || '未設定';
      if (!opMap[op]) opMap[op] = { total:0, connect:0, appo:0 };
      opMap[op].total++;
      if (isConnect(c.result)) opMap[op].connect++;
      if (isAppo(c.result)) opMap[op].appo++;
    });
    const avgRate = total > 0 ? (Object.values(opMap).reduce((s, o) => s + o.connect, 0) / total) : 0;

    const tbody = document.querySelector('#tableOperators tbody');
    tbody.innerHTML = Object.entries(opMap).sort((a,b) => b[1].total - a[1].total).map(([name, d]) => {
      const cRate = d.total > 0 ? d.connect / d.total : 0;
      const aRate = d.total > 0 ? d.appo / d.total : 0;
      const diff = ((cRate - avgRate) * 100).toFixed(1);
      const anomaly = Math.abs(parseFloat(diff)) > 20;
      return `<tr class="${anomaly ? 'anomaly' : ''}">
        <td>${esc(name)}</td><td>${d.total}</td><td>${d.connect}</td><td>${d.appo}</td>
        <td>${(cRate*100).toFixed(1)}%</td><td>${(aRate*100).toFixed(1)}%</td>
        <td>${diff > 0 ? '+' : ''}${diff}%</td></tr>`;
    }).join('');
  }

  function renderPersonal() {
    const op = document.getElementById('opFilter').value;
    const calls = dashData.calls.filter(c => !op || c.operator === op);
    const total = calls.length;
    const connected = calls.filter(c => isConnect(c.result)).length;
    const appos = calls.filter(c => isAppo(c.result)).length;

    const allTotal = dashData.calls.length;
    const allConnRate = allTotal > 0 ? dashData.calls.filter(c => isConnect(c.result)).length / allTotal : 0;
    const myConnRate = total > 0 ? connected / total : 0;
    const diff = ((myConnRate - allConnRate) * 100).toFixed(1);

    document.getElementById('kpiPersonal').innerHTML = [
      kpi('架電数', total, ''),
      kpi('通話数', connected, pct(connected, total)),
      kpi('アポ数', appos, pct(appos, total)),
      kpi('平均差', `${diff > 0 ? '+' : ''}${diff}%`, '通話率', Math.abs(parseFloat(diff)) > 20),
    ].join('');

    const daily = groupByDate(calls);
    charts.dailyPersonal = lineChart('chartDailyPersonal', Object.keys(daily), Object.values(daily), '架電数');

    const bizMap = {};
    const custMap = {};
    calls.forEach(c => { custMap[c.customerId] = true; });
    dashData.customers.forEach(cu => {
      if (!custMap[cu.id]) return;
      const bName = dashData.businesses.find(b => b.id === cu.businessId)?.name || cu.businessId;
      bizMap[bName] = (bizMap[bName] || 0) + 1;
    });
    if (Object.keys(bizMap).length > 0) {
      charts.bizPersonal = pieChart('chartBizPersonal', Object.keys(bizMap), Object.values(bizMap));
    }

    const tagCounts = {};
    calls.forEach(c => { const r = c.result || '未設定'; tagCounts[r] = (tagCounts[r] || 0) + 1; });
    charts.tagPersonal = pieChart('chartTagPersonal', Object.keys(tagCounts), Object.values(tagCounts));

    const custTagCounts = {};
    dashData.customers.filter(cu => custMap[cu.id]).forEach(cu => {
      (cu.tags || '').split(',').filter(Boolean).forEach(t => { custTagCounts[t.trim()] = (custTagCounts[t.trim()] || 0) + 1; });
    });
    if (Object.keys(custTagCounts).length > 0) {
      charts.custTagPersonal = pieChart('chartCustTagPersonal', Object.keys(custTagCounts), Object.values(custTagCounts));
    }
  }

  function renderBusiness() {
    const biz = document.getElementById('bizFilter').value;
    const customers = getFilteredCustomers();
    const calls = getFilteredCalls();
    const total = calls.length;
    const connected = calls.filter(c => isConnect(c.result)).length;
    const appos = calls.filter(c => isAppo(c.result)).length;
    const calledCust = customers.filter(c => c.callCount > 0).length;

    document.getElementById('kpiBusiness').innerHTML = [
      kpi('総顧客', customers.length, ''),
      kpi('架電済', calledCust, pct(calledCust, customers.length)),
      kpi('架電数', total, ''),
      kpi('アポ数', appos, pct(appos, total)),
    ].join('');

    const opMap = {};
    calls.forEach(c => { const op = c.operator || '未設定'; opMap[op] = (opMap[op] || 0) + 1; });
    charts.opBusiness = barChart('chartOpBusiness', Object.keys(opMap), Object.values(opMap), '架電数');

    const tagCounts = {};
    calls.forEach(c => { const r = c.result || '未設定'; tagCounts[r] = (tagCounts[r] || 0) + 1; });
    charts.tagBusiness = pieChart('chartTagBusiness', Object.keys(tagCounts), Object.values(tagCounts));

    const tbody = document.querySelector('#tableBizProgress tbody');
    const bizGroups = {};
    dashData.businesses.forEach(b => { bizGroups[b.id] = { name: b.name, total: 0, called: 0, uncalled: 0, appo: 0 }; });
    dashData.customers.forEach(cu => {
      if (!bizGroups[cu.businessId]) return;
      bizGroups[cu.businessId].total++;
      if (cu.callCount > 0) bizGroups[cu.businessId].called++;
      else bizGroups[cu.businessId].uncalled++;
    });
    dashData.calls.forEach(c => {
      if (!isAppo(c.result)) return;
      const cu = dashData.customers.find(x => x.id === c.customerId);
      if (cu && bizGroups[cu.businessId]) bizGroups[cu.businessId].appo++;
    });
    tbody.innerHTML = Object.values(bizGroups).map(g =>
      `<tr><td>${esc(g.name)}</td><td>${g.total}</td><td>${g.called}</td><td>${g.uncalled}</td><td>${g.appo}</td><td>${pct(g.called, g.total)}</td></tr>`
    ).join('');
  }

  function kpi(label, value, sub, highlight) {
    return `<div class="kpi-card${highlight ? ' highlight' : ''}"><div class="kpi-value">${value}</div><div class="kpi-label">${label}</div>${sub ? `<div class="kpi-sub">${sub}</div>` : ''}</div>`;
  }

  function groupByDate(calls) {
    const map = {};
    calls.forEach(c => { const d = (c.callDate || '').slice(0, 10); if (d) map[d] = (map[d] || 0) + 1; });
    const sorted = Object.keys(map).sort();
    const out = {};
    sorted.forEach(k => out[k] = map[k]);
    return out;
  }

  const PALETTE = ['#2563eb','#16a34a','#dc2626','#f59e0b','#7c3aed','#0891b2','#db2777','#ea580c','#4f46e5','#059669','#64748b','#a3a3a3'];

  function lineChart(canvasId, labels, data, label) {
    return new Chart(document.getElementById(canvasId), {
      type: 'line',
      data: { labels, datasets: [{ label, data, borderColor: PALETTE[0], backgroundColor: PALETTE[0]+'20', tension: 0.3, fill: true }] },
      options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });
  }
  function barChart(canvasId, labels, data, label) {
    return new Chart(document.getElementById(canvasId), {
      type: 'bar',
      data: { labels, datasets: [{ label, data, backgroundColor: PALETTE.slice(0, labels.length) }] },
      options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });
  }
  function pieChart(canvasId, labels, data) {
    return new Chart(document.getElementById(canvasId), {
      type: 'doughnut',
      data: { labels, datasets: [{ data, backgroundColor: PALETTE.slice(0, labels.length) }] },
      options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } } } }
    });
  }

  function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
  function showLoading(v) { document.getElementById('loading').classList.toggle('show', v); }

  async function loadDashboard() {
    showLoading(true);
    destroyCharts();
    try {
      const from = document.getElementById('dateFrom').value;
      const to = document.getElementById('dateTo').value;
      const toEnd = to ? to + 'T23:59:59' : undefined;
      dashData = await apiGetDashboardData(from || undefined, toEnd);
      renderOverview();
      renderPersonal();
      renderBusiness();
    } catch(e) {
      console.error('ダッシュボード読み込み失敗:', e);
    } finally { showLoading(false); }
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const auth = getCurrentUser();
    if (auth) {
      const el = document.getElementById('navUserInfo');
      if (el) el.textContent = `👤 ${auth.name}`;
      if (auth.role !== 'admin') { const li = document.getElementById('navSettingsLi'); if (li) li.style.display = 'none'; }
    }

    const today = new Date();
    const weekAgo = new Date(today);
    weekAgo.setDate(weekAgo.getDate() - 30);
    document.getElementById('dateFrom').value = weekAgo.toISOString().slice(0, 10);
    document.getElementById('dateTo').value = today.toISOString().slice(0, 10);

    await syncSettingsFromSupabase();

    const businesses = JSON.parse(localStorage.getItem('businesses') || '[]');
    const bizSel = document.getElementById('bizFilter');
    businesses.forEach(b => { const o = document.createElement('option'); o.value = b.id; o.textContent = b.name; bizSel.appendChild(o); });

    const operators = JSON.parse(localStorage.getItem('operators') || '[]');
    const opSel = document.getElementById('opFilter');
    operators.forEach(op => { const o = document.createElement('option'); o.value = op.name; o.textContent = op.name; opSel.appendChild(o); });

    await loadDashboard();

    document.getElementById('hamburger').addEventListener('click', () => {
      document.getElementById('navMenu').classList.toggle('open');
    });
  });
</script>

</body>
</html>
