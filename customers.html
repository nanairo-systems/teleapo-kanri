<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“</text></svg>">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é¡§å®¢ä¸€è¦§ - ãƒ†ãƒ¬ã‚¢ãƒé¡§å®¢ç®¡ç†</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<nav class="navbar">
  <div class="navbar-inner">
    <a href="index.html" class="navbar-brand"><span class="icon">ğŸ“</span>ãƒ†ãƒ¬ã‚¢ãƒé¡§å®¢ç®¡ç†</a>
    <button class="hamburger" id="hamburger"><span></span><span></span><span></span></button>
    <ul class="navbar-nav" id="navMenu">
      <li><a href="index.html">ğŸ  ãƒ›ãƒ¼ãƒ </a></li>
      <li><a href="#" class="active" id="navCustomers">ğŸ“‹ é¡§å®¢ä¸€è¦§</a></li>
      <li><a href="dashboard.html">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
      <li><a href="import.html">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</a></li>
      <li id="navSettingsLi"><a href="settings.html">âš™ï¸ è¨­å®š</a></li>
      <li class="nav-user" id="navUserInfo"></li>
      <li><button class="btn-logout" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button></li>
    </ul>
  </div>
</nav>

<div class="loading-overlay" id="loading"><div class="spinner"></div></div>
<div class="toast-container" id="toastContainer"></div>

<div class="container">
  <div class="breadcrumb">
    <a href="index.html">ãƒ›ãƒ¼ãƒ </a><span>â€º</span><span id="breadcrumbBiz">é¡§å®¢ä¸€è¦§</span>
  </div>

  <div class="biz-banner" id="bizBanner">
    <div class="biz-banner-icon" id="bizIcon">ğŸ“¦</div>
    <div class="biz-banner-info">
      <h1 id="bizName">æ¥­å‹™å</h1>
      <p id="bizDesc">æ¥­å‹™ã®èª¬æ˜</p>
    </div>
  </div>

  <div class="page-header">
    <div></div>
    <button class="btn btn-primary" onclick="openAddModal()">ï¼‹ æ–°è¦é¡§å®¢ç™»éŒ²</button>
  </div>

  <div class="stats-row">
    <div class="stat-card total"><div class="stat-value" id="statTotal">-</div><div class="stat-label">ç·é¡§å®¢æ•°</div></div>
    <div class="stat-card called"><div class="stat-value" id="statCalled">-</div><div class="stat-label">æ¶é›»æ¸ˆã¿</div></div>
    <div class="stat-card not-called"><div class="stat-value" id="statNotCalled">-</div><div class="stat-label">æœªæ¶é›»</div></div>
  </div>

  <div class="toolbar">
    <div class="toolbar-row">
      <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="searchInput" placeholder="ä¼šç¤¾åãƒ»æ‹…å½“è€…åãƒ»é›»è©±ç•ªå·ã§æ¤œç´¢..." oninput="saveFilterState();applyFilters()">
      </div>
      <select class="filter-select" id="callCountFilter" onchange="saveFilterState();applyFilters()">
        <option value="">ã™ã¹ã¦ã®æ¶é›»çŠ¶æ…‹</option>
        <option value="0">æœªæ¶é›»</option>
        <option value="1-3">1ã€œ3å›</option>
        <option value="4+">4å›ä»¥ä¸Š</option>
      </select>
      <select class="filter-select" id="sortSelect" onchange="saveFilterState();applyFilters()">
        <option value="updated_desc">æ›´æ–°æ—¥ï¼ˆæ–°ã—ã„é †ï¼‰</option>
        <option value="updated_asc">æ›´æ–°æ—¥ï¼ˆå¤ã„é †ï¼‰</option>
        <option value="company_asc">ä¼šç¤¾åï¼ˆæ˜‡é †ï¼‰</option>
        <option value="company_desc">ä¼šç¤¾åï¼ˆé™é †ï¼‰</option>
        <option value="calls_desc">æ¶é›»å›æ•°ï¼ˆå¤šã„é †ï¼‰</option>
        <option value="created_desc">ç™»éŒ²æ—¥ï¼ˆæ–°ã—ã„é †ï¼‰</option>
      </select>
    </div>
    <div class="toolbar-row">
      <div class="filter-tags" id="filterTags">
        <span class="filter-tags-label">ğŸ·ï¸ ã‚¿ã‚°çµã‚Šè¾¼ã¿:</span>
      </div>
      <button class="btn btn-sm btn-outline" id="tagModeBtn" onclick="toggleTagMode()" style="white-space:nowrap;margin-left:auto;">OR</button>
      <button class="btn btn-sm btn-outline" id="archiveToggle" onclick="toggleArchiveView()" style="white-space:nowrap;">ğŸ“¦ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</button>
    </div>
  </div>

  <!-- PC ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <div class="table-wrapper">
    <div class="table-scroll">
      <table>
        <thead><tr><th>ä¼šç¤¾å</th><th>é›»è©±ç•ªå·</th><th>ã‚¿ã‚°</th><th>æ¶é›»å›æ•°</th><th>æœ€çµ‚æ¶é›»æ—¥</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="customerTableBody"></tbody>
      </table>
    </div>
    <div class="pagination" id="pagination">
      <span id="paginationInfo"></span>
      <div class="pagination-buttons" id="paginationButtons"></div>
    </div>
  </div>

  <!-- ãƒ¢ãƒã‚¤ãƒ«ã‚«ãƒ¼ãƒ‰ -->
  <div class="mobile-cards" id="mobileCards"></div>
</div>

<!-- æ–°è¦é¡§å®¢ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-backdrop" id="addModal">
  <div class="modal">
    <div class="modal-header">
      <h2>æ–°è¦é¡§å®¢ç™»éŒ²</h2>
      <button class="modal-close" onclick="closeAddModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="addCustomerForm" onsubmit="return false">
        <div class="form-group"><label>ä¼šç¤¾å<span class="required">*</span></label><input type="text" name="companyName" required placeholder="ä¾‹ï¼šæ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«"></div>
        <div class="form-row">
          <div class="form-group"><label>æ‹…å½“è€…å</label><input type="text" name="contactName" placeholder="ä¾‹ï¼šå±±ç”°å¤ªéƒ"></div>
          <div class="form-group"><label>éƒ¨ç½²ãƒ»å½¹è·</label><input type="text" name="department" placeholder="ä¾‹ï¼šå–¶æ¥­éƒ¨ éƒ¨é•·"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>é›»è©±ç•ªå·<span class="required">*</span></label><input type="tel" name="phone" required placeholder="ä¾‹ï¼š03-1234-5678"></div>
          <div class="form-group"><label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><input type="email" name="email" placeholder="ä¾‹ï¼šyamada@example.com"></div>
        </div>
        <div class="form-group"><label>ä½æ‰€</label><input type="text" name="address" placeholder="ä¾‹ï¼šæ±äº¬éƒ½æ¸‹è°·åŒº..."></div>
        <div class="form-group"><label>å‚™è€ƒ</label><textarea name="notes" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."></textarea></div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeAddModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="doAddCustomer()">ç™»éŒ²ã™ã‚‹</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase-api.js"></script>
<script>
  // â”€â”€ èªè¨¼ãƒã‚§ãƒƒã‚¯ â”€â”€
  (function() {
    const a = JSON.parse(localStorage.getItem('authSession') || 'null');
    if (!a || Date.now() > a.expiry) { localStorage.removeItem('authSession'); location.replace('login.html'); }
  })();

  function logout() {
    if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.removeItem('authSession'); location.href = 'login.html'; }
  }

  const ROWS_PER_PAGE = 20;
  const CACHE_KEY_CUSTOMERS = () => `customers_${currentBusinessId}`;
  let allCustomers = [];
  let filteredCustomers = [];
  let currentPage = 1;
  let currentBusinessId = '';
  let currentBusiness = null;
  let activeTagFilters = new Set();
  let tagFilterMode = 'OR';
  let showingArchived = false;

  function getBusinessId() { return new URLSearchParams(window.location.search).get('businessId') || ''; }

  function getBusinessTags() {
    const tagsByBiz = JSON.parse(localStorage.getItem('customerTagsByBusiness') || '{}');
    return tagsByBiz[currentBusinessId] || ['è¦‹è¾¼ã¿é«˜', 'è¦‹è¾¼ã¿ä½', 'ã‚¢ãƒæ¸ˆã¿', 'æ–­ã‚Š', 'è¦ãƒ•ã‚©ãƒ­ãƒ¼'];
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const auth = getCurrentUser();
    if (auth) {
      const el = document.getElementById('navUserInfo');
      if (el) el.textContent = `ğŸ‘¤ ${auth.name}`;
      if (auth.role !== 'admin') { const li = document.getElementById('navSettingsLi'); if (li) li.style.display = 'none'; }
    }
    currentBusinessId = getBusinessId();
    if (!currentBusinessId) { window.location.href = 'index.html'; return; }
    if (!canAccessBusiness(currentBusinessId)) { alert('ã“ã®æ¥­å‹™ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“'); window.location.href = 'index.html'; return; }
    restoreFilterState();

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å³åº§ã«è¡¨ç¤º
    const cached = localStorage.getItem(CACHE_KEY_CUSTOMERS());
    if (cached) {
      try {
        allCustomers = JSON.parse(cached);
        const businesses = JSON.parse(localStorage.getItem('businesses') || '[]');
        currentBusiness = businesses.find(b => b.id === currentBusinessId);
        if (currentBusiness) { renderBanner(); updateNavLinks(); renderFilterTags(); applyFilters(); updateStats(allCustomers); }
      } catch(e) {}
    }

    // è¨­å®šã¨é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’åŒæ™‚å–å¾—ï¼ˆSupabaseï¼‰
    showLoading(true);
    try {
      const [, customersData] = await Promise.all([
        syncSettingsFromSupabase(),
        apiGetCustomers(currentBusinessId)
      ]);

      allCustomers = customersData.customers || [];
      localStorage.setItem(CACHE_KEY_CUSTOMERS(), JSON.stringify(allCustomers));

      const businesses = JSON.parse(localStorage.getItem('businesses') || '[]');
      currentBusiness = businesses.find(b => b.id === currentBusinessId);
      if (!currentBusiness) { window.location.href = 'index.html'; return; }

      renderBanner(); updateNavLinks(); renderFilterTags(); applyFilters(); updateStats(allCustomers);
    } catch(e) {
      if (!cached) {
        showToast('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'error');
        renderEmpty('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        updateStats([]);
      }
    } finally { showLoading(false); }

    document.getElementById('hamburger').addEventListener('click', () => {
      document.getElementById('navMenu').classList.toggle('open');
    });
  });

  function renderBanner() {
    document.title = `${currentBusiness.name} - ãƒ†ãƒ¬ã‚¢ãƒé¡§å®¢ç®¡ç†`;
    document.getElementById('bizIcon').textContent = currentBusiness.icon;
    document.getElementById('bizIcon').style.background = `${currentBusiness.color}15`;
    document.getElementById('bizName').textContent = currentBusiness.name;
    document.getElementById('bizDesc').textContent = currentBusiness.description || '';
    document.getElementById('breadcrumbBiz').textContent = currentBusiness.name;
    document.querySelector('.stat-card.total').style.borderTopColor = currentBusiness.color;
  }

  function updateNavLinks() {
    const biz = encodeURIComponent(currentBusinessId);
    document.getElementById('navCustomers').href = `customers.html?businessId=${biz}`;
  }

  function renderFilterTags() {
    const tags = getBusinessTags();
    const container = document.getElementById('filterTags');
    container.innerHTML = '<span class="filter-tags-label">ğŸ·ï¸ ã‚¿ã‚°çµã‚Šè¾¼ã¿:</span>' +
      `<button class="filter-tag-btn no-tag" data-tag="__none__" onclick="toggleFilterTag(this)">ã‚¿ã‚°ãªã—</button>` +
      tags.map(t => `<button class="filter-tag-btn" data-tag="${esc(t)}" onclick="toggleFilterTag(this)">${esc(t)}</button>`).join('');
  }

  function toggleFilterTag(btn) {
    const tag = btn.dataset.tag;
    if (activeTagFilters.has(tag)) { activeTagFilters.delete(tag); btn.classList.remove('active'); }
    else { activeTagFilters.add(tag); btn.classList.add('active'); }
    saveFilterState();
    applyFilters();
  }

  function toggleTagMode() {
    tagFilterMode = tagFilterMode === 'OR' ? 'AND' : 'OR';
    document.getElementById('tagModeBtn').textContent = tagFilterMode;
    saveFilterState();
    applyFilters();
  }

  async function toggleArchiveView() {
    showingArchived = !showingArchived;
    const btn = document.getElementById('archiveToggle');
    btn.textContent = showingArchived ? 'ğŸ“‹ é€šå¸¸ä¸€è¦§' : 'ğŸ“¦ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–';
    btn.style.background = showingArchived ? '#fef3c7' : '';
    showLoading(true);
    try {
      const data = showingArchived
        ? await apiGetArchivedCustomers(currentBusinessId)
        : await apiGetCustomers(currentBusinessId);
      allCustomers = data.customers || [];
      applyFilters();
      updateStats(allCustomers);
    } catch(e) { showToast('èª­ã¿è¾¼ã¿å¤±æ•—: ' + e.message, 'error'); }
    finally { showLoading(false); }
  }

  async function archiveCustomer(id, name) {
    if (!confirm(`ã€Œ${name}ã€ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã™ã‹ï¼Ÿ\nå¾Œã§ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä¸€è¦§ã‹ã‚‰å¾©å…ƒã§ãã¾ã™ã€‚`)) return;
    showLoading(true);
    try {
      await apiArchiveCustomer(id);
      showToast('ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã—ãŸ', 'success');
      await loadCustomers();
    } catch(e) { showToast('å¤±æ•—: ' + e.message, 'error'); }
    finally { showLoading(false); }
  }

  async function restoreCustomer(id, name) {
    if (!confirm(`ã€Œ${name}ã€ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ`)) return;
    showLoading(true);
    try {
      await apiRestoreCustomer(id);
      showToast('å¾©å…ƒã—ã¾ã—ãŸ', 'success');
      await toggleArchiveView();
    } catch(e) { showToast('å¤±æ•—: ' + e.message, 'error'); }
    finally { showLoading(false); }
  }

  function saveFilterState() {
    const state = {
      search: document.getElementById('searchInput').value,
      callFilter: document.getElementById('callCountFilter').value,
      sort: document.getElementById('sortSelect').value,
      tags: [...activeTagFilters],
      tagMode: tagFilterMode,
      scrollY: window.scrollY,
      page: currentPage,
    };
    sessionStorage.setItem(`filterState_${currentBusinessId}`, JSON.stringify(state));
  }

  function restoreFilterState() {
    const raw = sessionStorage.getItem(`filterState_${currentBusinessId}`);
    if (!raw) return;
    try {
      const s = JSON.parse(raw);
      if (s.search) document.getElementById('searchInput').value = s.search;
      if (s.callFilter) document.getElementById('callCountFilter').value = s.callFilter;
      if (s.sort) document.getElementById('sortSelect').value = s.sort;
      if (s.tags) { activeTagFilters = new Set(s.tags); }
      if (s.tagMode) { tagFilterMode = s.tagMode; document.getElementById('tagModeBtn').textContent = tagFilterMode; }
      if (s.page) currentPage = s.page;
      if (s.scrollY) setTimeout(() => window.scrollTo(0, s.scrollY), 100);
    } catch(e) {}
  }

  async function loadCustomers() {
    showLoading(true);
    try {
      const data = await apiGetCustomers(currentBusinessId);
      allCustomers = data.customers || [];
      localStorage.setItem(CACHE_KEY_CUSTOMERS(), JSON.stringify(allCustomers));
      applyFilters();
      updateStats(allCustomers);
    } catch(e) {
      showToast('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'error');
    } finally { showLoading(false); }
  }

  function updateStats(customers) {
    document.getElementById('statTotal').textContent = customers.length;
    document.getElementById('statCalled').textContent = customers.filter(c => (c.callCount || 0) > 0).length;
    document.getElementById('statNotCalled').textContent = customers.filter(c => (c.callCount || 0) === 0).length;
  }

  function applyFilters() {
    const query = document.getElementById('searchInput').value.toLowerCase().trim();
    const callFilter = document.getElementById('callCountFilter').value;
    const sortVal = document.getElementById('sortSelect').value;

    filteredCustomers = allCustomers.filter(c => {
      const matchSearch = !query ||
        (c.companyName || '').toLowerCase().includes(query) ||
        (c.contactName || '').toLowerCase().includes(query) ||
        (c.phone || '').includes(query);

      let matchCallCount = true;
      const cc = c.callCount || 0;
      if (callFilter === '0') matchCallCount = cc === 0;
      else if (callFilter === '1-3') matchCallCount = cc >= 1 && cc <= 3;
      else if (callFilter === '4+') matchCallCount = cc >= 4;

      let matchTags = true;
      if (activeTagFilters.size > 0) {
        const cTags = (c.tags || '').split(',').filter(Boolean).map(t => t.trim());
        const realTags = new Set(activeTagFilters);
        realTags.delete('__none__');
        const wantNoTag = activeTagFilters.has('__none__');
        const isNoTag = cTags.length === 0;

        if (realTags.size === 0 && wantNoTag) {
          matchTags = isNoTag;
        } else if (wantNoTag && realTags.size > 0) {
          matchTags = isNoTag || (tagFilterMode === 'AND'
            ? [...realTags].every(ft => cTags.includes(ft))
            : [...realTags].some(ft => cTags.includes(ft)));
        } else {
          matchTags = tagFilterMode === 'AND'
            ? [...realTags].every(ft => cTags.includes(ft))
            : [...realTags].some(ft => cTags.includes(ft));
        }
      }

      return matchSearch && matchCallCount && matchTags;
    });

    filteredCustomers.sort((a, b) => {
      switch (sortVal) {
        case 'updated_desc': return new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0);
        case 'updated_asc':  return new Date(a.updatedAt || 0) - new Date(b.updatedAt || 0);
        case 'company_asc':  return (a.companyName || '').localeCompare(b.companyName || '', 'ja');
        case 'company_desc': return (b.companyName || '').localeCompare(a.companyName || '', 'ja');
        case 'calls_desc':   return (b.callCount || 0) - (a.callCount || 0);
        case 'created_desc': return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
        default: return 0;
      }
    });
    currentPage = 1;
    renderTable();
    renderMobileCards();
  }

  function renderTable() {
    const tbody = document.getElementById('customerTableBody');
    const start = (currentPage - 1) * ROWS_PER_PAGE;
    const end = start + ROWS_PER_PAGE;
    const pageData = filteredCustomers.slice(start, end);
    const biz = encodeURIComponent(currentBusinessId);

    if (filteredCustomers.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-icon">ğŸ“­</div><p>è©²å½“ã™ã‚‹é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p></div></td></tr>`;
      document.getElementById('paginationInfo').textContent = '';
      document.getElementById('paginationButtons').innerHTML = '';
      return;
    }

    tbody.innerHTML = pageData.map(c => {
      const tags = (c.tags || '').split(',').filter(Boolean);
      const tagsHtml = tags.length > 0
        ? `<div class="tag-badges">${tags.map(t => `<span class="tag-badge">${esc(t.trim())}</span>`).join('')}</div>`
        : '<span style="color:var(--gray-400);font-size:12px;">-</span>';
      return `<tr>
        <td><a class="customer-name" href="detail.html?id=${encodeURIComponent(c.id)}&businessId=${biz}">${esc(c.companyName)}</a></td>
        <td>${esc(c.phone || '-')}</td>
        <td>${tagsHtml}</td>
        <td>${c.callCount || 0}å›</td>
        <td>${c.lastCallDate ? formatDate(c.lastCallDate) : '-'}</td>
        <td style="white-space:nowrap">
          ${showingArchived
            ? `<button class="btn btn-sm btn-outline" onclick="event.preventDefault();restoreCustomer('${c.id}','${esc(c.companyName)}')">â™»ï¸ å¾©å…ƒ</button>`
            : `<a class="btn btn-sm btn-outline" href="detail.html?id=${encodeURIComponent(c.id)}&businessId=${biz}">ğŸ“ æ¶é›»</a>
               <button class="btn btn-sm btn-outline" onclick="event.preventDefault();archiveCustomer('${c.id}','${esc(c.companyName)}')" title="ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–" style="padding:5px 8px;color:var(--gray-400);">ğŸ“¦</button>`}
        </td>
      </tr>`;
    }).join('');
    renderPagination();
  }

  function renderMobileCards() {
    const biz = encodeURIComponent(currentBusinessId);
    const container = document.getElementById('mobileCards');
    if (filteredCustomers.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“­</div><p>è©²å½“ã™ã‚‹é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p></div>';
      return;
    }
    container.innerHTML = filteredCustomers.map(c => {
      const tags = (c.tags || '').split(',').filter(Boolean);
      const tagsHtml = tags.length > 0
        ? `<div class="mobile-card-tags">${tags.map(t => `<span class="tag-badge">${esc(t.trim())}</span>`).join('')}</div>`
        : '';
      return `<a class="mobile-card" href="detail.html?id=${encodeURIComponent(c.id)}&businessId=${biz}">
        <div class="mobile-card-info">
          <div class="mobile-card-name">${esc(c.companyName)}</div>
          <div class="mobile-card-phone">${esc(c.phone || '-')}</div>
          ${tagsHtml}
          <div class="mobile-card-meta">${c.callCount || 0}å›æ¶é›» ${c.lastCallDate ? 'ãƒ»æœ€çµ‚ ' + formatDate(c.lastCallDate) : ''}</div>
        </div>
        <span class="mobile-card-arrow">â€º</span>
      </a>`;
    }).join('');
  }

  function renderPagination() {
    const total = filteredCustomers.length;
    const totalPages = Math.ceil(total / ROWS_PER_PAGE);
    const start = (currentPage - 1) * ROWS_PER_PAGE + 1;
    const end = Math.min(currentPage * ROWS_PER_PAGE, total);
    document.getElementById('paginationInfo').textContent = `${total}ä»¶ä¸­ ${start}ã€œ${end}ä»¶ã‚’è¡¨ç¤º`;
    const btns = document.getElementById('paginationButtons');
    if (totalPages <= 1) { btns.innerHTML = ''; return; }
    let html = `<button ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">â€¹ å‰</button>`;
    const range = getPageRange(currentPage, totalPages);
    for (const p of range) {
      if (p === '...') html += `<button disabled>â€¦</button>`;
      else html += `<button class="${p === currentPage ? 'active' : ''}" onclick="goToPage(${p})">${p}</button>`;
    }
    html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">æ¬¡ â€º</button>`;
    btns.innerHTML = html;
  }

  function getPageRange(current, total) {
    if (total <= 7) return Array.from({length: total}, (_, i) => i + 1);
    if (current <= 3) return [1, 2, 3, 4, '...', total];
    if (current >= total - 2) return [1, '...', total - 3, total - 2, total - 1, total];
    return [1, '...', current - 1, current, current + 1, '...', total];
  }

  function goToPage(page) { currentPage = page; renderTable(); window.scrollTo({ top: 0, behavior: 'smooth' }); }

  function openAddModal() { document.getElementById('addCustomerForm').reset(); document.getElementById('addModal').classList.add('show'); }
  function closeAddModal() { document.getElementById('addModal').classList.remove('show'); }

  async function doAddCustomer() {
    const form = document.getElementById('addCustomerForm');
    const companyName = (form.companyName.value || '').trim();
    const phone       = (form.phone.value || '').trim();

    if (!companyName) { showToast('ä¼šç¤¾åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    if (!phone)       { showToast('é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    if (!currentBusinessId) { showToast('æ¥­å‹™IDãŒå–å¾—ã§ãã¾ã›ã‚“', 'error'); return; }

    showLoading(true);
    try {
      const dups = await apiCheckDuplicates(companyName, phone, currentBusinessId);
      if (dups.sameBusinessDups.length > 0) {
        const dupNames = dups.sameBusinessDups.map(d => `ãƒ»${d.companyName}ï¼ˆ${d.phone}ï¼‰[${d.matchType}]`).join('\n');
        if (!confirm(`âš ï¸ åŒä¸€æ¥­å‹™å†…ã«é‡è¤‡å€™è£œãŒã‚ã‚Šã¾ã™:\n${dupNames}\n\nãã‚Œã§ã‚‚ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) {
          showLoading(false); return;
        }
      }
      await apiAddCustomer({
        businessId:  currentBusinessId,
        companyName,
        contactName: (form.contactName.value || '').trim(),
        department:  (form.department.value  || '').trim(),
        phone,
        email:       (form.email.value   || '').trim(),
        address:     (form.address.value || '').trim(),
        notes:       (form.notes.value   || '').trim(),
      });
      showToast('é¡§å®¢ã‚’ç™»éŒ²ã—ã¾ã—ãŸ âœ…', 'success');
      closeAddModal();
      form.reset();
      await loadCustomers();
    } catch(e) {
      showToast('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e.message || String(e)), 'error');
    } finally { showLoading(false); }
  }

  function renderEmpty(message) {
    document.getElementById('customerTableBody').innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-icon">ğŸ“‹</div><p>${message}</p></div></td></tr>`;
    document.getElementById('paginationInfo').textContent = '';
    document.getElementById('paginationButtons').innerHTML = '';
    document.getElementById('mobileCards').innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><p>${message}</p></div>`;
  }

  function formatDate(d) { if (!d) return '-'; const dt = new Date(d); if (isNaN(dt)) return d; return `${dt.getFullYear()}/${String(dt.getMonth()+1).padStart(2,'0')}/${String(dt.getDate()).padStart(2,'0')}`; }
  function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
  function showLoading(v) { document.getElementById('loading').classList.toggle('show', v); }
  function showToast(msg, type = 'success') {
    const c = document.getElementById('toastContainer');
    const t = document.createElement('div'); t.className = `toast ${type}`;
    t.innerHTML = `<span>${type==='success'?'âœ…':'âŒ'}</span> ${esc(msg)}`;
    c.appendChild(t);
    setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(() => t.remove(), 300); }, 4000);
  }
  document.getElementById('addModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeAddModal(); });
</script>

</body>
</html>
