<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ - ãƒ†ãƒ¬ã‚¢ãƒé¡§å®¢ç®¡ç†</title>
  <style>
    :root {
      --primary: #2563eb; --primary-hover: #1d4ed8; --success: #16a34a;
      --warning: #f59e0b; --danger: #dc2626; --info: #0891b2;
      --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
      --gray-300: #d1d5db; --gray-400: #9ca3af; --gray-500: #6b7280;
      --gray-600: #4b5563; --gray-700: #374151; --gray-800: #1f2937;
      --gray-900: #111827; --radius: 8px;
      --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; background: var(--gray-50); color: var(--gray-800); line-height: 1.6; }

    .navbar { background: #fff; border-bottom: 1px solid var(--gray-200); padding: 0 24px; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); }
    .navbar-inner { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; height: 56px; }
    .navbar-brand { font-size: 18px; font-weight: 700; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 8px; }
    .navbar-brand .icon { font-size: 22px; }
    .navbar-nav { display: flex; gap: 4px; list-style: none; }
    .navbar-nav a { display: flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: var(--radius); text-decoration: none; color: var(--gray-600); font-size: 14px; font-weight: 500; transition: background 0.15s, color 0.15s; }
    .navbar-nav a:hover { background: var(--gray-100); color: var(--gray-800); }
    .navbar-nav a.active { background: #eff6ff; color: var(--primary); }
    .btn-logout { background: none; border: 1px solid var(--gray-300); border-radius: var(--radius); padding: 5px 12px; font-size: 13px; cursor: pointer; color: var(--gray-600); font-weight: 500; transition: all 0.15s; }
    .btn-logout:hover { background: #fef2f2; color: var(--danger); border-color: #fecaca; }
    .nav-user { font-size: 13px; color: var(--gray-500); padding: 0 4px; display: flex; align-items: center; white-space: nowrap; }
    .hamburger { display: none; background: none; border: none; cursor: pointer; flex-direction: column; gap: 5px; padding: 4px; }
    .hamburger span { display: block; width: 22px; height: 2px; background: var(--gray-600); border-radius: 2px; }

    .container { max-width: 960px; margin: 0 auto; padding: 24px; }
    .breadcrumb { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--gray-500); margin-bottom: 20px; flex-wrap: wrap; }
    .breadcrumb a { color: var(--primary); text-decoration: none; }
    .breadcrumb a:hover { text-decoration: underline; }

    .page-header { margin-bottom: 24px; }
    .page-header h1 { font-size: 22px; font-weight: 700; color: var(--gray-900); }
    .page-header p { font-size: 14px; color: var(--gray-500); margin-top: 4px; }

    .card { background: #fff; border: 1px solid var(--gray-200); border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; }
    .card-header { padding: 16px 20px; border-bottom: 1px solid var(--gray-200); }
    .card-header h2 { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .card-header p { font-size: 13px; color: var(--gray-500); margin-top: 4px; }
    .card-body { padding: 20px; }

    /* â”€â”€ æ¥­å‹™é¸æŠ â”€â”€ */
    .form-group { margin-bottom: 18px; }
    .form-group label { display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px; }
    .form-group label .required { color: var(--danger); margin-left: 2px; }
    .form-group select, .form-group input { width: 100%; padding: 10px 14px; border: 1px solid var(--gray-300); border-radius: var(--radius); font-size: 14px; font-family: inherit; outline: none; transition: border-color 0.15s; }
    .form-group select:focus, .form-group input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

    /* â”€â”€ ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ â”€â”€ */
    .drop-zone {
      border: 2px dashed var(--gray-300); border-radius: var(--radius);
      padding: 48px 24px; text-align: center; cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      position: relative;
    }
    .drop-zone:hover, .drop-zone.dragover { border-color: var(--primary); background: #f8faff; }
    .drop-zone-icon { font-size: 48px; margin-bottom: 12px; }
    .drop-zone-text { font-size: 15px; color: var(--gray-600); margin-bottom: 4px; }
    .drop-zone-hint { font-size: 13px; color: var(--gray-400); }
    .drop-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    .file-selected { display: none; align-items: center; gap: 12px; padding: 12px 16px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: var(--radius); margin-top: 12px; }
    .file-selected.show { display: flex; }
    .file-selected .file-name { flex: 1; font-weight: 600; font-size: 14px; color: var(--gray-800); }
    .file-selected .file-size { font-size: 12px; color: var(--gray-500); }
    .file-remove { background: none; border: none; font-size: 18px; cursor: pointer; color: var(--gray-400); }
    .file-remove:hover { color: var(--danger); }

    /* â”€â”€ åˆ—åã‚¬ã‚¤ãƒ‰ â”€â”€ */
    .column-guide { overflow-x: auto; }
    .column-guide table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .column-guide th { background: var(--gray-50); padding: 8px 12px; text-align: left; font-weight: 600; color: var(--gray-600); border-bottom: 1px solid var(--gray-200); white-space: nowrap; }
    .column-guide td { padding: 8px 12px; border-bottom: 1px solid var(--gray-100); color: var(--gray-700); }
    .column-guide tr:last-child td { border-bottom: none; }
    .col-required { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 11px; font-weight: 700; background: #fee2e2; color: #991b1b; }
    .col-optional { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 11px; font-weight: 700; background: var(--gray-100); color: var(--gray-500); }

    .guide-note {
      background: #fffbeb; border: 1px solid #fde68a; border-radius: var(--radius);
      padding: 12px 16px; font-size: 13px; color: #92400e; line-height: 1.7;
    }
    .guide-note strong { color: #78350f; }

    /* â”€â”€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ â”€â”€ */
    .preview-wrapper { overflow-x: auto; max-height: 400px; overflow-y: auto; }
    .preview-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .preview-table th { position: sticky; top: 0; background: var(--primary); color: #fff; padding: 8px 10px; text-align: left; font-weight: 600; white-space: nowrap; z-index: 1; }
    .preview-table td { padding: 6px 10px; border-bottom: 1px solid var(--gray-100); white-space: nowrap; max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
    .preview-table tr:nth-child(even) { background: var(--gray-50); }
    .preview-table .row-error { background: #fef2f2; }
    .preview-table .cell-error { color: var(--danger); font-weight: 600; }

    .preview-stats {
      display: flex; gap: 16px; flex-wrap: wrap; padding: 12px 0;
      font-size: 14px; color: var(--gray-600);
    }
    .preview-stats .stat { display: flex; align-items: center; gap: 6px; }
    .preview-stats .stat-dot { width: 8px; height: 8px; border-radius: 50%; }
    .preview-stats .dot-ok { background: var(--success); }
    .preview-stats .dot-warn { background: var(--warning); }
    .preview-stats .dot-err { background: var(--danger); }

    .mapping-info {
      display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;
    }
    .mapping-chip {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 600;
    }
    .mapping-chip.matched { background: #dcfce7; color: #166534; }
    .mapping-chip.missing { background: #fee2e2; color: #991b1b; }
    .mapping-chip.extra { background: var(--gray-100); color: var(--gray-500); }

    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 18px; border: none; border-radius: var(--radius); font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.15s, transform 0.1s; text-decoration: none; white-space: nowrap; }
    .btn:active { transform: scale(0.97); }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-success { background: var(--success); color: #fff; }
    .btn-success:hover { background: #15803d; }
    .btn-outline { background: #fff; color: var(--gray-700); border: 1px solid var(--gray-300); }
    .btn-outline:hover { background: var(--gray-100); }
    .btn-lg { padding: 12px 32px; font-size: 16px; }
    .btn:disabled { opacity: 0.5; cursor: default; }
    .form-actions { display: flex; gap: 12px; justify-content: flex-end; padding-top: 8px; }

    .result-banner { padding: 20px; border-radius: var(--radius); text-align: center; margin-bottom: 20px; }
    .result-banner.success { background: #dcfce7; border: 1px solid #86efac; }
    .result-banner.error { background: #fee2e2; border: 1px solid #fca5a5; }
    .result-banner .result-icon { font-size: 40px; margin-bottom: 8px; }
    .result-banner .result-text { font-size: 18px; font-weight: 700; }
    .result-banner .result-detail { font-size: 14px; color: var(--gray-600); margin-top: 4px; }

    .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.7); z-index: 200; align-items: center; justify-content: center; }
    .loading-overlay.show { display: flex; }
    .spinner { width: 40px; height: 40px; border: 4px solid var(--gray-200); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .toast-container { position: fixed; top: 70px; right: 24px; z-index: 400; display: flex; flex-direction: column; gap: 8px; }
    .toast { background: #fff; border: 1px solid var(--gray-200); border-radius: var(--radius); padding: 12px 16px; box-shadow: var(--shadow-md); font-size: 14px; display: flex; align-items: center; gap: 8px; animation: slideIn 0.3s ease; max-width: 360px; }
    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--danger); }
    @keyframes slideIn { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }

    .step-indicator { display: flex; align-items: center; gap: 0; margin-bottom: 24px; }
    .step { display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: var(--gray-400); }
    .step.active { color: var(--primary); }
    .step.done { color: var(--success); }
    .step-num { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; border: 2px solid var(--gray-300); }
    .step.active .step-num { border-color: var(--primary); background: var(--primary); color: #fff; }
    .step.done .step-num { border-color: var(--success); background: var(--success); color: #fff; }
    .step-line { width: 40px; height: 2px; background: var(--gray-200); margin: 0 8px; }
    .step-line.done { background: var(--success); }

    @media (max-width: 768px) {
      .navbar { padding: 0 12px; }
      .navbar-inner { position: relative; }
      .hamburger { display: flex; }
      .navbar-nav { display: none; position: absolute; top: 56px; left: -12px; right: -12px; background: #fff; border-bottom: 1px solid var(--gray-200); flex-direction: column; padding: 8px; box-shadow: var(--shadow-md); z-index: 101; }
      .navbar-nav.open { display: flex; }
      .navbar-nav a { padding: 12px 16px; font-size: 15px; }
      .container { padding: 16px; }
      .drop-zone { padding: 32px 16px; }
    }
  </style>
</head>
<body>

<nav class="navbar">
  <div class="navbar-inner">
    <a href="index.html" class="navbar-brand"><span class="icon">ğŸ“</span>ãƒ†ãƒ¬ã‚¢ãƒé¡§å®¢ç®¡ç†</a>
    <button class="hamburger" id="hamburger"><span></span><span></span><span></span></button>
    <ul class="navbar-nav" id="navMenu">
      <li><a href="index.html">ğŸ  ãƒ›ãƒ¼ãƒ </a></li>
      <li><a href="import.html" class="active">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</a></li>
      <li id="navSettingsLi"><a href="settings.html">âš™ï¸ è¨­å®š</a></li>
      <li class="nav-user" id="navUserInfo"></li>
      <li><button class="btn-logout" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button></li>
    </ul>
  </div>
</nav>

<div class="loading-overlay" id="loading"><div class="spinner"></div></div>
<div class="toast-container" id="toastContainer"></div>

<div class="container">
  <div class="breadcrumb">
    <a href="index.html">ãƒ›ãƒ¼ãƒ </a><span>â€º</span><span>CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</span>
  </div>

  <div class="page-header">
    <h1>ğŸ“¥ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h1>
    <p>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬ç™»éŒ²ã—ã¾ã™</p>
  </div>

  <!-- ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤º -->
  <div class="step-indicator">
    <div class="step active" id="step1"><span class="step-num">1</span>ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</div>
    <div class="step-line" id="line1"></div>
    <div class="step" id="step2"><span class="step-num">2</span>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç¢ºèª</div>
    <div class="step-line" id="line2"></div>
    <div class="step" id="step3"><span class="step-num">3</span>ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†</div>
  </div>

  <!-- ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -->
  <div id="phase1">
    <div class="card">
      <div class="card-header"><h2>ğŸ“ ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ˆã®æ¥­å‹™ã‚’é¸æŠ</h2></div>
      <div class="card-body">
        <div class="form-group">
          <label>æ¥­å‹™<span class="required">*</span></label>
          <select id="businessSelect"></select>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><h2>ğŸ“„ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</h2></div>
      <div class="card-body">
        <div class="drop-zone" id="dropZone">
          <input type="file" accept=".csv,.tsv,.txt" id="fileInput" onchange="handleFileSelect(event)">
          <div class="drop-zone-icon">ğŸ“„</div>
          <div class="drop-zone-text">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã€ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</div>
          <div class="drop-zone-hint">å¯¾å¿œå½¢å¼: CSVï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰ã€TSVï¼ˆã‚¿ãƒ–åŒºåˆ‡ã‚Šï¼‰/ UTF-8 æ¨å¥¨</div>
        </div>
        <div class="file-selected" id="fileSelected">
          <span>ğŸ“„</span>
          <span class="file-name" id="fileName"></span>
          <span class="file-size" id="fileSize"></span>
          <button class="file-remove" onclick="clearFile()">&times;</button>
        </div>
      </div>
    </div>

    <!-- åˆ—åã‚¬ã‚¤ãƒ‰ -->
    <div class="card">
      <div class="card-header">
        <h2>ğŸ“– ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h2>
        <p>CSVãƒ•ã‚¡ã‚¤ãƒ«ã®1è¡Œç›®ã«ä»¥ä¸‹ã®åˆ—åã‚’å«ã‚ã¦ãã ã•ã„ã€‚åˆ—ã®é †ç•ªã¯è‡ªç”±ã§ã™ã€‚</p>
      </div>
      <div class="card-body">
        <div class="column-guide">
          <table>
            <thead><tr><th>åˆ—å</th><th>å¿…é ˆ</th><th>èª¬æ˜</th><th>ä¾‹</th></tr></thead>
            <tbody>
              <tr><td><strong>ä¼šç¤¾å</strong></td><td><span class="col-required">å¿…é ˆ</span></td><td>é¡§å®¢ã®ä¼šç¤¾åãƒ»å±‹å·</td><td>æ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«</td></tr>
              <tr><td><strong>é›»è©±ç•ªå·</strong></td><td><span class="col-required">å¿…é ˆ</span></td><td>ãƒ¡ã‚¤ãƒ³ã®é›»è©±ç•ªå·</td><td>03-1234-5678</td></tr>
              <tr><td><strong>æ‹…å½“è€…å</strong></td><td><span class="col-optional">ä»»æ„</span></td><td>å…ˆæ–¹ã®æ‹…å½“è€…å</td><td>å±±ç”°å¤ªéƒ</td></tr>
              <tr><td><strong>éƒ¨ç½²å½¹è·</strong></td><td><span class="col-optional">ä»»æ„</span></td><td>æ‹…å½“è€…ã®éƒ¨ç½²ãƒ»å½¹è·</td><td>å–¶æ¥­éƒ¨ éƒ¨é•·</td></tr>
              <tr><td><strong>ãƒ¡ãƒ¼ãƒ«</strong></td><td><span class="col-optional">ä»»æ„</span></td><td>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</td><td>yamada@example.com</td></tr>
              <tr><td><strong>ä½æ‰€</strong></td><td><span class="col-optional">ä»»æ„</span></td><td>ä½æ‰€</td><td>æ±äº¬éƒ½æ¸‹è°·åŒº1-2-3</td></tr>
              <tr><td><strong>å‚™è€ƒ</strong></td><td><span class="col-optional">ä»»æ„</span></td><td>ãƒ¡ãƒ¢ãƒ»å‚™è€ƒæ¬„</td><td>åˆå‰ä¸­ãŒç¹‹ãŒã‚Šã‚„ã™ã„</td></tr>
              <tr><td><strong>ã‚¿ã‚°</strong></td><td><span class="col-optional">ä»»æ„</span></td><td>ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°ã‚¿ã‚°æŒ‡å®šå¯èƒ½</td><td>è¦‹è¾¼ã¿é«˜,ææ–™ã‚ã‚Š</td></tr>
            </tbody>
          </table>
        </div>
        <div class="guide-note" style="margin-top: 16px;">
          <strong>ğŸ’¡ ãƒã‚¤ãƒ³ãƒˆ</strong><br>
          ãƒ»åˆ—åã¯1è¡Œç›®ã«è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚åˆ—ã®<strong>é †ç•ªã¯è‡ªç”±</strong>ã§ã™ã€‚<br>
          ãƒ»ã€Œä¼šç¤¾åã€ã¨ã€Œé›»è©±ç•ªå·ã€ã¯å¿…é ˆã§ã™ã€‚æœªå…¥åŠ›ã®è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚<br>
          ãƒ»èªè­˜ã§ããªã„åˆ—åã¯ç„¡è¦–ã•ã‚Œã¾ã™ï¼ˆã‚¨ãƒ©ãƒ¼ã«ã¯ãªã‚Šã¾ã›ã‚“ï¼‰ã€‚<br>
          ãƒ»æ–‡å­—ã‚³ãƒ¼ãƒ‰ã¯ UTF-8 ã‚’æ¨å¥¨ã—ã¾ã™ã€‚Shift_JIS ã‚‚è‡ªå‹•åˆ¤å®šã§å¯¾å¿œã—ã¾ã™ã€‚
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
  <div id="phase2" style="display:none;">
    <div class="card">
      <div class="card-header"><h2>ğŸ” åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°çµæœ</h2></div>
      <div class="card-body">
        <div class="mapping-info" id="mappingInfo"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><h2>ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2></div>
      <div class="card-body">
        <div class="preview-stats" id="previewStats"></div>
        <div class="preview-wrapper">
          <table class="preview-table" id="previewTable"></table>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button class="btn btn-outline" onclick="goBack()">â† æˆ»ã‚‹</button>
      <button class="btn btn-success btn-lg" id="importBtn" onclick="executeImport()">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
    </div>
  </div>

  <!-- ã‚¹ãƒ†ãƒƒãƒ—3: å®Œäº† -->
  <div id="phase3" style="display:none;">
    <div class="result-banner" id="resultBanner">
      <div class="result-icon" id="resultIcon"></div>
      <div class="result-text" id="resultText"></div>
      <div class="result-detail" id="resultDetail"></div>
    </div>
    <div class="form-actions">
      <a href="index.html" class="btn btn-outline">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
      <button class="btn btn-primary" onclick="resetAll()">ğŸ“¥ ç¶šã‘ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase-api.js"></script>
<script>
  const KNOWN_COLUMNS = {
    'ä¼šç¤¾å': 'companyName', 'é›»è©±ç•ªå·': 'phone', 'æ‹…å½“è€…å': 'contactName',
    'éƒ¨ç½²å½¹è·': 'department', 'ãƒ¡ãƒ¼ãƒ«': 'email', 'ä½æ‰€': 'address',
    'å‚™è€ƒ': 'notes', 'ã‚¿ã‚°': 'tags'
  };
  const REQUIRED_COLS = ['ä¼šç¤¾å', 'é›»è©±ç•ªå·'];

  let parsedRows = [];
  let columnMapping = {};
  let validRows = [];


  // â”€â”€ èªè¨¼ãƒã‚§ãƒƒã‚¯ â”€â”€
  (function() {
    const a = JSON.parse(localStorage.getItem('authSession') || 'null');
    if (!a || Date.now() > a.expiry) { localStorage.removeItem('authSession'); location.replace('login.html'); }
  })();

  function logout() {
    if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.removeItem('authSession'); location.href = 'login.html'; }
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const auth = JSON.parse(localStorage.getItem('authSession') || 'null');
    if (auth) {
      const el = document.getElementById('navUserInfo');
      if (el) el.textContent = `ğŸ‘¤ ${auth.name}`;
      if (auth.role !== 'admin') { const li = document.getElementById('navSettingsLi'); if (li) li.style.display = 'none'; }
    }
    await syncSettingsFromSupabase();
    populateBusinessSelect();
    setupDragDrop();
    document.getElementById('hamburger').addEventListener('click', () => {
      document.getElementById('navMenu').classList.toggle('open');
    });
  });

  function populateBusinessSelect() {
    const businesses = JSON.parse(localStorage.getItem('businesses') || '[]');
    const sel = document.getElementById('businessSelect');
    sel.innerHTML = '<option value="">-- æ¥­å‹™ã‚’é¸æŠ --</option>' +
      businesses.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
    const p = new URLSearchParams(window.location.search);
    if (p.get('businessId')) sel.value = p.get('businessId');
  }

  function setupDragDrop() {
    const dz = document.getElementById('dropZone');
    dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
    dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
    dz.addEventListener('drop', e => {
      e.preventDefault(); dz.classList.remove('dragover');
      if (e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]);
    });
  }

  function handleFileSelect(e) { if (e.target.files.length) processFile(e.target.files[0]); }

  function processFile(file) {
    if (!file.name.match(/\.(csv|tsv|txt)$/i)) { showToast('CSV/TSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; }
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatSize(file.size);
    document.getElementById('fileSelected').classList.add('show');

    const reader = new FileReader();
    reader.onload = e => {
      let text = e.target.result;
      if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
      parseCSV(text, file.name.endsWith('.tsv') ? '\t' : ',');
    };
    reader.readAsText(file, 'UTF-8');
  }

  function clearFile() {
    document.getElementById('fileInput').value = '';
    document.getElementById('fileSelected').classList.remove('show');
    parsedRows = [];
    columnMapping = {};
  }

  function parseCSV(text, delimiter) {
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    if (lines.length < 2) { showToast('ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼‹1è¡Œä»¥ä¸Šå¿…è¦ï¼‰', 'error'); return; }

    const headers = parseCSVLine(lines[0], delimiter).map(h => h.trim());
    columnMapping = {};
    headers.forEach((h, i) => {
      const mapped = KNOWN_COLUMNS[h];
      if (mapped) columnMapping[i] = { original: h, field: mapped };
    });

    parsedRows = [];
    for (let i = 1; i < lines.length; i++) {
      const cols = parseCSVLine(lines[i], delimiter);
      const row = { _raw: cols, _errors: [] };
      for (const [idx, map] of Object.entries(columnMapping)) {
        row[map.field] = (cols[parseInt(idx)] || '').trim();
      }
      if (!row.companyName) row._errors.push('ä¼šç¤¾åãŒç©º');
      if (!row.phone) row._errors.push('é›»è©±ç•ªå·ãŒç©º');
      parsedRows.push(row);
    }
    showPreview(headers);
  }

  function parseCSVLine(line, delimiter) {
    const result = []; let current = ''; let inQuote = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (inQuote) {
        if (ch === '"' && line[i + 1] === '"') { current += '"'; i++; }
        else if (ch === '"') inQuote = false;
        else current += ch;
      } else {
        if (ch === '"') inQuote = true;
        else if (ch === delimiter) { result.push(current); current = ''; }
        else current += ch;
      }
    }
    result.push(current);
    return result;
  }

  function showPreview(headers) {
    if (!document.getElementById('businessSelect').value) {
      showToast('å…ˆã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ˆã®æ¥­å‹™ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return;
    }

    setStep(2);
    document.getElementById('phase1').style.display = 'none';
    document.getElementById('phase2').style.display = '';

    const mappingEl = document.getElementById('mappingInfo');
    const allKnown = Object.keys(KNOWN_COLUMNS);
    const mappedNames = Object.values(columnMapping).map(m => m.original);
    const unmappedHeaders = headers.filter(h => !KNOWN_COLUMNS[h]);

    mappingEl.innerHTML =
      mappedNames.map(n => `<span class="mapping-chip matched">âœ“ ${n}</span>`).join('') +
      allKnown.filter(k => !mappedNames.includes(k)).map(k =>
        `<span class="mapping-chip ${REQUIRED_COLS.includes(k) ? 'missing' : 'extra'}">âœ— ${k}${REQUIRED_COLS.includes(k) ? 'ï¼ˆå¿…é ˆï¼‰' : ''}</span>`
      ).join('') +
      unmappedHeaders.map(h => `<span class="mapping-chip extra">? ${h}ï¼ˆç„¡è¦–ï¼‰</span>`).join('');

    const missingReq = REQUIRED_COLS.filter(r => !mappedNames.includes(r));
    if (missingReq.length) {
      showToast(`å¿…é ˆåˆ—ã€Œ${missingReq.join('ã€ã€Œ')}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, 'error');
      document.getElementById('importBtn').disabled = true;
    } else {
      document.getElementById('importBtn').disabled = false;
    }

    validRows = parsedRows.filter(r => r._errors.length === 0);
    const errorRows = parsedRows.filter(r => r._errors.length > 0);

    document.getElementById('previewStats').innerHTML = `
      <div class="stat"><span class="stat-dot dot-ok"></span>æœ‰åŠ¹: ${validRows.length}ä»¶</div>
      <div class="stat"><span class="stat-dot dot-err"></span>ã‚¨ãƒ©ãƒ¼: ${errorRows.length}ä»¶</div>
      <div class="stat">åˆè¨ˆ: ${parsedRows.length}ä»¶</div>
    `;

    const displayCols = Object.values(columnMapping).map(m => m.original);
    const pt = document.getElementById('previewTable');
    const maxPreview = Math.min(parsedRows.length, 100);
    pt.innerHTML = `<thead><tr><th>#</th><th>çŠ¶æ…‹</th>${displayCols.map(c => `<th>${c}</th>`).join('')}</tr></thead>
      <tbody>${parsedRows.slice(0, maxPreview).map((r, i) => {
        const hasErr = r._errors.length > 0;
        return `<tr class="${hasErr ? 'row-error' : ''}"><td>${i + 1}</td><td>${hasErr ? 'âŒ' : 'âœ…'}</td>${
          Object.values(columnMapping).map(m => {
            const val = r[m.field] || '';
            const isErrField = REQUIRED_COLS.includes(m.original) && !val;
            return `<td class="${isErrField ? 'cell-error' : ''}">${esc(val || '-')}</td>`;
          }).join('')}</tr>`;
      }).join('')}</tbody>`;
    if (parsedRows.length > maxPreview) {
      pt.innerHTML += `<tfoot><tr><td colspan="${displayCols.length + 2}" style="text-align:center;padding:12px;color:var(--gray-400);">ä»– ${parsedRows.length - maxPreview}ä»¶ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çœç•¥ï¼‰</td></tr></tfoot>`;
    }
  }

  function goBack() {
    setStep(1);
    document.getElementById('phase1').style.display = '';
    document.getElementById('phase2').style.display = 'none';
  }

  async function executeImport() {
    if (validRows.length === 0) { showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error'); return; }

    const businessId = document.getElementById('businessSelect').value;
    const customers = validRows.map(r => ({
      businessId,
      companyName: r.companyName || '',
      contactName: r.contactName || '',
      department:  r.department  || '',
      phone:       r.phone       || '',
      email:       r.email       || '',
      address:     r.address     || '',
      notes:       r.notes       || '',
      tags:        r.tags        || '',
    }));

    showLoading(true);
    try {
      const result = await apiBulkImport(customers);
      showResult(true, result.imported || customers.length);
    } catch(e) {
      showResult(false, 0, e.message);
    } finally {
      showLoading(false);
    }
  }

  function showResult(success, count, errorMsg) {
    setStep(3);
    document.getElementById('phase2').style.display = 'none';
    document.getElementById('phase3').style.display = '';

    const banner = document.getElementById('resultBanner');
    banner.className = `result-banner ${success ? 'success' : 'error'}`;
    document.getElementById('resultIcon').textContent = success ? 'ğŸ‰' : 'âŒ';
    document.getElementById('resultText').textContent = success ? 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼' : 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—';
    document.getElementById('resultDetail').textContent = success
      ? `${count}ä»¶ã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`
      : `ã‚¨ãƒ©ãƒ¼: ${errorMsg}`;
  }

  function resetAll() {
    setStep(1);
    document.getElementById('phase1').style.display = '';
    document.getElementById('phase2').style.display = 'none';
    document.getElementById('phase3').style.display = 'none';
    clearFile();
    parsedRows = []; columnMapping = {}; validRows = [];
  }

  function setStep(n) {
    for (let i = 1; i <= 3; i++) {
      const el = document.getElementById(`step${i}`);
      el.className = 'step' + (i < n ? ' done' : i === n ? ' active' : '');
    }
    document.getElementById('line1').className = 'step-line' + (n > 1 ? ' done' : '');
    document.getElementById('line2').className = 'step-line' + (n > 2 ? ' done' : '');
  }

  function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  }
  function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
  function showLoading(v) { document.getElementById('loading').classList.toggle('show', v); }
  function showToast(msg, type = 'success') {
    const c = document.getElementById('toastContainer'); const t = document.createElement('div'); t.className = `toast ${type}`;
    t.innerHTML = `<span>${type==='success'?'âœ…':'âŒ'}</span> ${esc(msg)}`;
    c.appendChild(t); setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(() => t.remove(), 300); }, 4000);
  }
</script>

</body>
</html>
