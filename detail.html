<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“</text></svg>">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é¡§å®¢è©³ç´° - ãƒ†ãƒ¬ã‚¢ãƒé¡§å®¢ç®¡ç†</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<nav class="navbar">
  <div class="navbar-inner">
    <a href="index.html" class="navbar-brand"><span class="icon">ğŸ“</span>ãƒ†ãƒ¬ã‚¢ãƒé¡§å®¢ç®¡ç†</a>
    <button class="hamburger" id="hamburger"><span></span><span></span><span></span></button>
    <ul class="navbar-nav" id="navMenu">
      <li><a href="index.html">ğŸ  ãƒ›ãƒ¼ãƒ </a></li>
      <li><a href="#" id="navCustomers">ğŸ“‹ é¡§å®¢ä¸€è¦§</a></li>
      <li><a href="dashboard.html">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
      <li><a href="import.html">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</a></li>
      <li id="navSettingsLi"><a href="settings.html">âš™ï¸ è¨­å®š</a></li>
      <li class="nav-user" id="navUserInfo"></li>
      <li><button class="btn-logout" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button></li>
    </ul>
  </div>
</nav>

<div class="loading-overlay" id="loading"><div class="spinner"></div></div>
<div class="toast-container" id="toastContainer"></div>

<div class="container">
  <div class="breadcrumb">
    <a href="index.html">ãƒ›ãƒ¼ãƒ </a><span>â€º</span>
    <a href="#" id="bcBiz">æ¥­å‹™</a><span>â€º</span>
    <span id="bcName">é¡§å®¢è©³ç´°</span>
  </div>

  <div class="page-header">
    <div style="display:flex;align-items:center;gap:12px;">
      <button class="btn btn-outline btn-sm" onclick="goBackToList()">â† æˆ»ã‚‹</button>
      <h1 id="pageTitle">é¡§å®¢è©³ç´°</h1>
    </div>
  </div>

  <div id="crossBizDups" style="display:none;margin-bottom:16px;padding:12px 16px;background:#fffbeb;border:1px solid #fde68a;border-radius:8px;font-size:13px;"></div>

  <!-- é›»è©±ç™ºä¿¡ãƒœã‚¿ãƒ³ -->
  <div class="call-actions" id="callActions" style="display:none;">
    <a class="call-action-btn phone" id="telBtn" href="#">
      <span class="btn-icon">ğŸ“±</span>
      <span class="btn-label">é›»è©±ã‚’ã‹ã‘ã‚‹<small>ç«¯æœ«ã®é›»è©±ã‚¢ãƒ—ãƒªã§ç™ºä¿¡</small></span>
    </a>
    <a class="call-action-btn zoom" id="zoomBtn" href="#">
      <span class="btn-icon">ğŸ’»</span>
      <span class="btn-label">Zoom Phoneã§ç™ºä¿¡<small>Zoomã‚¢ãƒ—ãƒªã§ç™ºä¿¡</small></span>
    </a>
  </div>

  <!-- æ¶é›»çµæœç™»éŒ²ãƒ‘ãƒãƒ«ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
  <div class="call-panel" id="callPanel">
    <div class="call-panel-toggle" id="callPanelToggle" onclick="toggleCallPanel()">
      <h2>ğŸ“ æ¶é›»çµæœã‚’ç™»éŒ²</h2>
      <span class="toggle-arrow">â–¼</span>
    </div>
    <div class="call-panel-body" id="callPanelBody">
      <div class="call-panel-inner">
        <form id="callForm" onsubmit="return handleCallSubmit(event)">
          <div class="timer-section">
            <div class="timer-display" id="timerDisplay">00:00</div>
            <div class="timer-buttons">
              <button type="button" class="btn btn-success btn-sm" id="timerStart" onclick="startTimer()">â–¶ é–‹å§‹</button>
              <button type="button" class="btn btn-outline btn-sm" id="timerStop" onclick="stopTimer()" style="display:none;">â¸ åœæ­¢</button>
              <button type="button" class="btn btn-outline btn-sm" onclick="resetTimer()">â†» ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
          </div>

          <div class="section-label">ğŸ“ é›»è©±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆ1ã¤é¸æŠï¼‰</div>
          <div class="tag-buttons" id="callStatusButtons" style="margin-bottom:16px;"></div>

          <div class="section-label">ğŸ·ï¸ é¡§å®¢ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ã‚°ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</div>
          <div class="tag-buttons" id="tagButtons"></div>

          <div class="form-row">
            <div class="form-group">
              <label>æ¶é›»æ—¥æ™‚</label>
              <input type="datetime-local" id="callDate">
            </div>
            <div class="form-group">
              <label>å¯¾å¿œè€…</label>
              <div id="operatorDisplay" class="operator-display">â€”</div>
            </div>
          </div>

          <div class="form-group">
            <label>ãƒ¡ãƒ¢</label>
            <textarea id="callMemo" placeholder="é€šè©±å†…å®¹ã‚„æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãªã©ã‚’è¨˜éŒ²..."></textarea>
          </div>

          <input type="hidden" id="callDuration">

          <div class="form-actions-inline">
            <button type="button" class="btn btn-outline" onclick="toggleCallPanel()">é–‰ã˜ã‚‹</button>
            <button type="submit" class="btn btn-primary">ğŸ’¾ æ¶é›»çµæœã‚’ç™»éŒ²</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="two-col">
    <!-- å·¦: é¡§å®¢æƒ…å ± -->
    <div>
      <div class="card">
        <div class="card-header">
          <h2>ğŸ“‹ é¡§å®¢æƒ…å ±</h2>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-outline btn-sm" onclick="openEditModal()">âœï¸ ç·¨é›†</button>
            <button class="btn btn-outline btn-sm" onclick="handleArchive()" title="ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–">ğŸ“¦ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</button>
            <button class="btn btn-danger btn-sm" onclick="handleDelete()">ğŸ—‘ï¸ å‰Šé™¤</button>
          </div>
        </div>
        <div class="card-body">
          <div class="customer-tags" id="customerTagsDisplay"></div>
          <div class="info-grid" id="customerInfo" style="margin-top:14px;"></div>
        </div>
      </div>

      <!-- å‚™è€ƒã‚«ãƒ¼ãƒ‰ -->
      <div class="card">
        <div class="card-header">
          <h2>ğŸ“ å‚™è€ƒ</h2>
          <button class="btn btn-outline btn-sm" onclick="openAddNoteForm()">ï¼‹ è¿½åŠ </button>
        </div>
        <div class="card-body">
          <!-- å‚™è€ƒè¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰ -->
          <div id="addNoteForm" class="note-add-form" style="display:none;">
            <textarea id="noteInput" placeholder="å‚™è€ƒã‚’å…¥åŠ›..." rows="3"></textarea>
            <div class="form-actions-inline" style="margin-top:8px;">
              <button class="btn btn-sm btn-outline" onclick="closeAddNoteForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              <button class="btn btn-sm btn-primary" onclick="doAddNote()">è¿½åŠ ã™ã‚‹</button>
            </div>
          </div>
          <div id="notesContainer"></div>
        </div>
      </div>
    </div>

    <!-- å³: æ¶é›»å±¥æ­´ -->
    <div>
      <div class="card">
        <div class="card-header">
          <h2>ğŸ“ æ¶é›»å±¥æ­´</h2>
          <span style="font-size:13px;color:var(--text-muted);" id="callCountLabel">0ä»¶</span>
        </div>
        <div class="card-body">
          <div id="callHistory">
            <div class="empty-state"><div class="empty-icon">ğŸ“­</div><p>æ¶é›»å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- é¡§å®¢ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-backdrop" id="editModal">
  <div class="modal">
    <div class="modal-header"><h2>é¡§å®¢æƒ…å ±ã®ç·¨é›†</h2><button class="modal-close" onclick="closeEditModal()">&times;</button></div>
    <div class="modal-body">
      <form id="editForm" onsubmit="return handleEdit(event)">
        <div class="form-group"><label>ä¼šç¤¾å<span class="required">*</span></label><input type="text" name="companyName" required></div>
        <div class="form-row">
          <div class="form-group"><label>æ‹…å½“è€…å</label><input type="text" name="contactName"></div>
          <div class="form-group"><label>éƒ¨ç½²ãƒ»å½¹è·</label><input type="text" name="department"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>é›»è©±ç•ªå·<span class="required">*</span></label><input type="tel" name="phone" required></div>
          <div class="form-group"><label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><input type="email" name="email"></div>
        </div>
        <div class="form-group"><label>ä½æ‰€</label><input type="text" name="address"></div>
        <div class="form-group">
          <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ã‚°</label>
          <div class="tag-buttons" id="editTagButtons"></div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="document.getElementById('editForm').requestSubmit()">ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- é€šè©±è¨˜éŒ²ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-backdrop" id="editCallModal">
  <div class="modal">
    <div class="modal-header"><h2>é€šè©±è¨˜éŒ²ã®ç·¨é›†</h2><button class="modal-close" onclick="closeEditCallModal()">&times;</button></div>
    <div class="modal-body">
      <div class="form-group">
        <label>æ¶é›»æ—¥æ™‚</label>
        <input type="datetime-local" id="editCallDate">
      </div>
      <div class="form-group">
        <label>é›»è©±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
        <div class="tag-buttons" id="editCallStatusButtons"></div>
      </div>
      <div class="form-group">
        <label>é€šè©±æ™‚é–“</label>
        <input type="text" id="editCallDuration" placeholder="ä¾‹: 03:45">
      </div>
      <div class="form-group">
        <label>ãƒ¡ãƒ¢</label>
        <textarea id="editCallMemo"></textarea>
      </div>
      <input type="hidden" id="editingCallId">
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeEditCallModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="handleEditCall()">ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase-api.js"></script>
<script>
  // â”€â”€ èªè¨¼ãƒã‚§ãƒƒã‚¯ â”€â”€
  (function() {
    const a = JSON.parse(localStorage.getItem('authSession') || 'null');
    if (!a || Date.now() > a.expiry) { localStorage.removeItem('authSession'); location.replace('login.html'); }
  })();

  function logout() {
    if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.removeItem('authSession'); location.href = 'login.html'; }
  }

  const CALL_STATUSES = ['ä¸åœ¨', 'å³åˆ‡ã‚Š', 'å¯¾å¿œã‚ã‚Š', 'æ‹…å½“è€…å¯¾å¿œ', 'æŠ˜ã‚Šè¿”ã—å¾…ã¡'];

  let customer = null;
  let callRecords = [];
  let businessId = '';
  let selectedTags = new Set();
  let editTags = new Set();
  let timerInterval = null;
  let timerSeconds = 0;
  let timerRunning = false;
  let selectedCallStatus = '';
  let editingCallStatus = '';

  function getParams() {
    const p = new URLSearchParams(window.location.search);
    return { id: p.get('id'), businessId: p.get('businessId') || '' };
  }

  function getBusinessTags() {
    const tagsByBiz = JSON.parse(localStorage.getItem('customerTagsByBusiness') || '{}');
    return tagsByBiz[businessId] || ['è¦‹è¾¼ã¿é«˜', 'è¦‹è¾¼ã¿ä½', 'ã‚¢ãƒæ¸ˆã¿', 'æ–­ã‚Š', 'è¦ãƒ•ã‚©ãƒ­ãƒ¼'];
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const auth = JSON.parse(localStorage.getItem('authSession') || 'null');
    if (auth) {
      const el = document.getElementById('navUserInfo');
      if (el) el.textContent = `ğŸ‘¤ ${auth.name}`;
      if (auth.role !== 'admin') { const li = document.getElementById('navSettingsLi'); if (li) li.style.display = 'none'; }
    }
    const params = getParams();
    businessId = params.businessId;
    if (!params.id) { window.location.href = 'index.html'; return; }

    updateNavLinks();
    setOperatorDisplay();
    initCallDate();
    renderCallStatusButtons();

    showLoading(true);
    try {
      const [, customerData] = await Promise.all([
        syncSettingsFromSupabase(),
        apiGetCustomer(params.id)
      ]);
      updateNavLinks();
      setOperatorDisplay();
      customer = customerData.customer;
      callRecords = customerData.callHistory || [];
      renderDetail();
      renderTagButtons();
      loadCrossBusinessDuplicates();
    } catch(e) { showToast('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'error'); }
    finally { showLoading(false); }

    document.getElementById('hamburger').addEventListener('click', () => {
      document.getElementById('navMenu').classList.toggle('open');
    });
  });

  function updateNavLinks() {
    const biz = encodeURIComponent(businessId);
    document.getElementById('navCustomers').href = `customers.html?businessId=${biz}`;
    document.getElementById('bcBiz').href = `customers.html?businessId=${biz}`;
    const businesses = JSON.parse(localStorage.getItem('businesses') || '[]');
    const b = businesses.find(x => x.id === businessId);
    if (b) document.getElementById('bcBiz').textContent = b.name;
  }

  function initCallDate() {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('callDate').value = now.toISOString().slice(0, 16);
  }

  async function loadCustomerDetail(id) {
    showLoading(true);
    try {
      const data = await apiGetCustomer(id);
      customer = data.customer;
      callRecords = data.callHistory || [];
      renderDetail();
      renderTagButtons();
    } catch(e) { showToast('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'error'); }
    finally { showLoading(false); }
  }

  function renderDetail() {
    if (!customer) return;
    document.title = `${customer.companyName} - ãƒ†ãƒ¬ã‚¢ãƒé¡§å®¢ç®¡ç†`;
    document.getElementById('bcName').textContent = customer.companyName;
    document.getElementById('pageTitle').textContent = customer.companyName;

    const phone = String(customer.phone || '');
    const phoneClean = phone.replace(/[-\s()]/g, '');

    const tags = (customer.tags || '').split(',').filter(Boolean);
    document.getElementById('customerTagsDisplay').innerHTML = tags.length > 0
      ? tags.map(t => `<span class="badge badge-tag">${esc(t.trim())}</span>`).join(' ')
      : '<span style="font-size:13px;color:var(--text-muted);">ã‚¿ã‚°ãªã—</span>';

    document.getElementById('customerInfo').innerHTML = `
      <div class="info-item"><span class="info-label">ä¼šç¤¾å</span><span class="info-value">${esc(customer.companyName)}</span></div>
      <div class="info-item"><span class="info-label">æ‹…å½“è€…</span><span class="info-value">${esc(customer.contactName || '-')}</span></div>
      <div class="info-item"><span class="info-label">éƒ¨ç½²ãƒ»å½¹è·</span><span class="info-value">${esc(customer.department || '-')}</span></div>
      <div class="info-item"><span class="info-label">é›»è©±ç•ªå·</span><span class="info-value"><a href="tel:${esc(phone)}">${esc(phone || '-')}</a></span></div>
      <div class="info-item"><span class="info-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</span><span class="info-value">${customer.email ? `<a href="mailto:${esc(customer.email)}">${esc(customer.email)}</a>` : '-'}</span></div>
      <div class="info-item"><span class="info-label">ä½æ‰€</span><span class="info-value">${esc(customer.address || '-')}</span></div>
      <div class="info-item"><span class="info-label">æ¶é›»å›æ•°</span><span class="info-value">${customer.callCount || 0}å›</span></div>
      <div class="info-item"><span class="info-label">æœ€çµ‚æ¶é›»æ—¥</span><span class="info-value">${customer.lastCallDate ? formatDate(customer.lastCallDate) : '-'}</span></div>
      <div class="info-item"><span class="info-label">ç™»éŒ²æ—¥</span><span class="info-value">${formatDate(customer.createdAt)}</span></div>
      <div class="info-item"><span class="info-label">æ›´æ–°æ—¥</span><span class="info-value">${formatDate(customer.updatedAt)}</span></div>`;

    if (phoneClean) {
      document.getElementById('telBtn').href = `tel:${phoneClean}`;
      document.getElementById('zoomBtn').href = `zoomphonecall://${phoneClean}`;
      document.getElementById('callActions').style.display = '';
    }

    renderNotes();
    renderCallHistory();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // å‚™è€ƒç®¡ç†
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function parseNotes() {
    if (!customer || !customer.notes) return [];
    try {
      const parsed = JSON.parse(customer.notes);
      if (Array.isArray(parsed)) return parsed;
    } catch(e) {}
    // æ—§å½¢å¼ï¼ˆãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã‚’å˜ä¸€ã‚¨ãƒ³ãƒˆãƒªã«å¤‰æ›
    return [{ id: 'legacy', date: customer.createdAt || new Date().toISOString(), author: 'ç™»éŒ²æ™‚', content: customer.notes }];
  }

  function renderNotes() {
    const notes = parseNotes();
    const container = document.getElementById('notesContainer');
    if (notes.length === 0) {
      container.innerHTML = '<p style="color:var(--text-muted);font-size:14px;padding:4px 0;">å‚™è€ƒã¯ã‚ã‚Šã¾ã›ã‚“</p>';
      return;
    }
    const sorted = [...notes].sort((a, b) => new Date(b.date) - new Date(a.date));
    container.innerHTML = sorted.map(n => `
      <div class="note-entry">
        <div class="note-meta">
          <span class="note-date">${formatDateTime(n.date)}</span>
          <span class="note-author">${esc(n.author || '-')}</span>
          ${n.id !== 'legacy' ? `<button class="note-delete-btn" onclick="deleteNote('${n.id}')" title="ã“ã®å‚™è€ƒã‚’å‰Šé™¤">Ã—</button>` : ''}
        </div>
        <div class="note-content">${esc(n.content)}</div>
      </div>`).join('');
  }

  function openAddNoteForm() {
    document.getElementById('addNoteForm').style.display = '';
    document.getElementById('noteInput').focus();
  }

  function closeAddNoteForm() {
    document.getElementById('addNoteForm').style.display = 'none';
    document.getElementById('noteInput').value = '';
  }

  async function doAddNote() {
    const content = document.getElementById('noteInput').value.trim();
    if (!content) { showToast('å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    const auth = getCurrentUser();
    const notes = parseNotes();
    notes.push({
      id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
      date: new Date().toISOString(),
      author: auth?.name || 'ä¸æ˜',
      content
    });
    showLoading(true);
    try {
      await apiUpdateCustomer({ id: customer.id, notes: JSON.stringify(notes) });
      customer.notes = JSON.stringify(notes);
      renderNotes();
      closeAddNoteForm();
      showToast('å‚™è€ƒã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
    } catch(e) { showToast('å¤±æ•—: ' + e.message, 'error'); }
    finally { showLoading(false); }
  }

  async function deleteNote(noteId) {
    if (!confirm('ã“ã®å‚™è€ƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    const notes = parseNotes().filter(n => n.id !== noteId);
    showLoading(true);
    try {
      await apiUpdateCustomer({ id: customer.id, notes: JSON.stringify(notes) });
      customer.notes = JSON.stringify(notes);
      renderNotes();
      showToast('å‚™è€ƒã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    } catch(e) { showToast('å¤±æ•—: ' + e.message, 'error'); }
    finally { showLoading(false); }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // é›»è©±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function renderCallStatusButtons() {
    document.getElementById('callStatusButtons').innerHTML = CALL_STATUSES.map(s => {
      const sel = selectedCallStatus === s ? ' selected' : '';
      return `<button type="button" class="call-status-btn${sel}" data-status="${esc(s)}" onclick="selectCallStatus(this)">${esc(s)}</button>`;
    }).join('');
  }

  function selectCallStatus(btn) {
    selectedCallStatus = selectedCallStatus === btn.dataset.status ? '' : btn.dataset.status;
    renderCallStatusButtons();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // é¡§å®¢ã‚¿ã‚°æ“ä½œ
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function renderTagButtons() {
    const availableTags = getBusinessTags();
    const currentTags = customer ? (customer.tags || '').split(',').filter(Boolean).map(t => t.trim()) : [];
    selectedTags = new Set(currentTags);

    document.getElementById('tagButtons').innerHTML = availableTags.map(tag => {
      const sel = selectedTags.has(tag) ? ' selected' : '';
      return `<button type="button" class="tag-btn${sel}" data-tag="${esc(tag)}" onclick="toggleTag(this, 'selectedTags')">${esc(tag)}</button>`;
    }).join('');
  }

  function toggleTag(btn, setName) {
    const tagSet = setName === 'editTags' ? editTags : selectedTags;
    const tag = btn.dataset.tag;
    if (tagSet.has(tag)) { tagSet.delete(tag); btn.classList.remove('selected'); }
    else { tagSet.add(tag); btn.classList.add('selected'); }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // æ¶é›»å±¥æ­´
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function renderCallHistory() {
    const container = document.getElementById('callHistory');
    document.getElementById('callCountLabel').textContent = `${callRecords.length}ä»¶`;
    if (callRecords.length === 0) {
      container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“­</div><p>æ¶é›»å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p></div>`;
      return;
    }
    const sorted = [...callRecords].sort((a, b) => new Date(b.callDate) - new Date(a.callDate));
    container.innerHTML = `<div class="timeline">${sorted.map(r => {
      const resultBadge = r.result ? `<span class="badge badge-call-status">${esc(r.result)}</span>` : '';
      return `<div class="timeline-item">
        <div class="timeline-dot"></div>
        <div class="timeline-header">
          <span class="timeline-date">${formatDateTime(r.callDate)}</span>
          ${resultBadge}
          <div class="timeline-actions">
            <button class="btn btn-sm btn-outline" style="padding:3px 8px;" onclick="openEditCallModal('${r.id}')" title="ç·¨é›†">âœï¸</button>
            <button class="btn btn-sm btn-outline" style="padding:3px 8px;color:var(--danger);" onclick="handleDeleteCall('${r.id}')" title="å‰Šé™¤">ğŸ—‘ï¸</button>
          </div>
        </div>
        <div class="timeline-body">${esc(r.memo || 'ãƒ¡ãƒ¢ãªã—')}</div>
        <div class="timeline-meta">å¯¾å¿œè€…: ${esc(r.operator || '-')} ï¼ é€šè©±æ™‚é–“: ${r.duration || '-'}</div>
      </div>`;
    }).join('')}</div>`;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // é€šè©±è¨˜éŒ² ç·¨é›†ãƒ»å‰Šé™¤
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function openEditCallModal(callId) {
    const call = callRecords.find(r => r.id === callId);
    if (!call) return;
    document.getElementById('editingCallId').value = callId;
    const dt = new Date(call.callDate);
    dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
    document.getElementById('editCallDate').value = dt.toISOString().slice(0, 16);
    document.getElementById('editCallDuration').value = call.duration || '';
    document.getElementById('editCallMemo').value = call.memo || '';
    editingCallStatus = call.result || '';
    renderEditCallStatusButtons();
    document.getElementById('editCallModal').classList.add('show');
  }

  function closeEditCallModal() { document.getElementById('editCallModal').classList.remove('show'); }

  function renderEditCallStatusButtons() {
    document.getElementById('editCallStatusButtons').innerHTML = CALL_STATUSES.map(s => {
      const sel = editingCallStatus === s ? ' selected' : '';
      return `<button type="button" class="call-status-btn${sel}" data-status="${esc(s)}" onclick="selectEditCallStatus(this)">${esc(s)}</button>`;
    }).join('');
  }

  function selectEditCallStatus(btn) {
    editingCallStatus = editingCallStatus === btn.dataset.status ? '' : btn.dataset.status;
    renderEditCallStatusButtons();
  }

  async function handleEditCall() {
    const callId = document.getElementById('editingCallId').value;
    showLoading(true);
    try {
      await apiUpdateCallRecord(callId, {
        callDate: document.getElementById('editCallDate').value,
        result:   editingCallStatus,
        duration: document.getElementById('editCallDuration').value.trim(),
        memo:     document.getElementById('editCallMemo').value.trim(),
      });
      showToast('é€šè©±è¨˜éŒ²ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
      closeEditCallModal();
      await loadCustomerDetail(customer.id);
    } catch(e) { showToast('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'error'); }
    finally { showLoading(false); }
  }

  async function handleDeleteCall(callId) {
    if (!confirm('ã“ã®é€šè©±è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\næ¶é›»å›æ•°ã‚‚1ä»¶æ¸›ã‚Šã¾ã™ã€‚')) return;
    showLoading(true);
    try {
      await apiDeleteCallRecord(callId, customer.id);
      showToast('é€šè©±è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
      await loadCustomerDetail(customer.id);
    } catch(e) { showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'error'); }
    finally { showLoading(false); }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // æ¶é›»ç™»éŒ²ãƒ‘ãƒãƒ«
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function toggleCallPanel() {
    const toggle = document.getElementById('callPanelToggle');
    const body = document.getElementById('callPanelBody');
    toggle.classList.toggle('open');
    body.classList.toggle('open');
  }

  function setOperatorDisplay() {
    const auth = getCurrentUser();
    const el = document.getElementById('operatorDisplay');
    if (el) el.textContent = auth?.name || 'â€”';
  }

  // â”€â”€ ã‚¿ã‚¤ãƒãƒ¼ â”€â”€
  function startTimer() {
    if (timerRunning) return;
    timerRunning = true;
    document.getElementById('timerDisplay').classList.add('active');
    document.getElementById('timerStart').style.display = 'none';
    document.getElementById('timerStop').style.display = '';
    timerInterval = setInterval(() => { timerSeconds++; updateTimerDisplay(); }, 1000);
  }
  function stopTimer() {
    timerRunning = false; clearInterval(timerInterval);
    document.getElementById('timerDisplay').classList.remove('active');
    document.getElementById('timerStart').style.display = '';
    document.getElementById('timerStop').style.display = 'none';
    document.getElementById('callDuration').value = fmtTimer(timerSeconds);
  }
  function resetTimer() { stopTimer(); timerSeconds = 0; updateTimerDisplay(); document.getElementById('callDuration').value = ''; }
  function updateTimerDisplay() { document.getElementById('timerDisplay').textContent = fmtTimer(timerSeconds); }
  function fmtTimer(s) { return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; }

  // â”€â”€ æ¶é›»çµæœé€ä¿¡ â”€â”€
  async function handleCallSubmit(event) {
    event.preventDefault();
    const auth = getCurrentUser();
    if (!auth?.name) { showToast('ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error'); return false; }
    if (timerRunning) stopTimer();

    showLoading(true);
    try {
      await apiAddCallRecord({
        customerId: customer.id,
        callDate:   document.getElementById('callDate').value,
        result:     selectedCallStatus,
        duration:   document.getElementById('callDuration').value || fmtTimer(timerSeconds),
        operator:   auth.name,
        memo:       document.getElementById('callMemo').value.trim(),
        tags:       [...selectedTags].join(','),
      });
      showToast('æ¶é›»çµæœã‚’ç™»éŒ²ã—ã¾ã—ãŸ', 'success');
      document.getElementById('callMemo').value = '';
      selectedCallStatus = '';
      renderCallStatusButtons();
      resetTimer();
      initCallDate();
      await loadCustomerDetail(customer.id);
    } catch(e) { showToast('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'error'); }
    finally { showLoading(false); }
    return false;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // é¡§å®¢ç·¨é›†
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function openEditModal() {
    if (!customer) return;
    const f = document.getElementById('editForm');
    f.companyName.value = customer.companyName || '';
    f.contactName.value = customer.contactName || '';
    f.department.value = customer.department || '';
    f.phone.value = customer.phone || '';
    f.email.value = customer.email || '';
    f.address.value = customer.address || '';

    editTags = new Set((customer.tags || '').split(',').filter(Boolean).map(t => t.trim()));
    const availableTags = getBusinessTags();
    document.getElementById('editTagButtons').innerHTML = availableTags.map(tag => {
      const sel = editTags.has(tag) ? ' selected' : '';
      return `<button type="button" class="tag-btn${sel}" data-tag="${esc(tag)}" onclick="toggleTag(this, 'editTags')">${esc(tag)}</button>`;
    }).join('');

    document.getElementById('editModal').classList.add('show');
  }
  function closeEditModal() { document.getElementById('editModal').classList.remove('show'); }

  async function handleEdit(event) {
    event.preventDefault();
    const f = event.target;
    showLoading(true);
    try {
      await apiUpdateCustomer({
        id:          customer.id,
        companyName: f.companyName.value.trim(),
        contactName: f.contactName.value.trim(),
        department:  f.department.value.trim(),
        phone:       f.phone.value.trim(),
        email:       f.email.value.trim(),
        address:     f.address.value.trim(),
        tags:        [...editTags].join(','),
      });
      showToast('é¡§å®¢æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
      closeEditModal();
      await loadCustomerDetail(customer.id);
    } catch(e) { showToast('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'error'); }
    finally { showLoading(false); }
    return false;
  }

  async function handleDelete() {
    if (!confirm(`ã€Œ${customer.companyName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) return;
    showLoading(true);
    try {
      await apiDeleteCustomer(customer.id);
      showToast('é¡§å®¢ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
      setTimeout(() => { window.location.href = `customers.html?businessId=${encodeURIComponent(businessId)}`; }, 1000);
    } catch(e) { showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'error'); }
    finally { showLoading(false); }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // æˆ»ã‚‹ãƒ»ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ»ä»–æ¥­å‹™é‡è¤‡
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function goBackToList() {
    window.location.href = `customers.html?businessId=${encodeURIComponent(businessId)}`;
  }

  async function handleArchive() {
    if (!customer) return;
    if (!confirm(`ã€Œ${customer.companyName}ã€ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã™ã‹ï¼Ÿ\nã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä¸€è¦§ã‹ã‚‰å¾©å…ƒã§ãã¾ã™ã€‚`)) return;
    showLoading(true);
    try {
      await apiArchiveCustomer(customer.id);
      showToast('ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã—ãŸ', 'success');
      setTimeout(() => goBackToList(), 1000);
    } catch(e) { showToast('å¤±æ•—: ' + e.message, 'error'); }
    finally { showLoading(false); }
  }

  async function loadCrossBusinessDuplicates() {
    if (!customer) return;
    try {
      const dups = await apiGetCrossBusinessDuplicates(customer.companyName, customer.phone, customer.id);
      if (dups.length === 0) return;
      const businesses = JSON.parse(localStorage.getItem('businesses') || '[]');
      const el = document.getElementById('crossBizDups');
      el.style.display = '';
      el.innerHTML = `<strong>âš ï¸ ä»–æ¥­å‹™ã«ã‚‚å­˜åœ¨:</strong><br>` +
        dups.map(d => {
          const biz = businesses.find(b => b.id === d.businessId);
          return `ãƒ»${biz ? biz.name : d.businessId} / ${esc(d.companyName)} / æ¶é›»${d.callCount}å› ${d.lastCallDate ? '/ æœ€çµ‚ ' + formatDate(d.lastCallDate) : ''}`;
        }).join('<br>');
    } catch(e) {}
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function formatDate(d) { if (!d) return '-'; const dt = new Date(d); if (isNaN(dt)) return d; return `${dt.getFullYear()}/${String(dt.getMonth()+1).padStart(2,'0')}/${String(dt.getDate()).padStart(2,'0')}`; }
  function formatDateTime(d) { if (!d) return '-'; const dt = new Date(d); if (isNaN(dt)) return d; return `${dt.getFullYear()}/${String(dt.getMonth()+1).padStart(2,'0')}/${String(dt.getDate()).padStart(2,'0')} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`; }
  function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
  function showLoading(v) { document.getElementById('loading').classList.toggle('show', v); }
  function showToast(msg, type = 'success') {
    const c = document.getElementById('toastContainer'); const t = document.createElement('div'); t.className = `toast ${type}`;
    t.innerHTML = `<span>${type==='success'?'âœ…':'âŒ'}</span> ${esc(msg)}`;
    c.appendChild(t); setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(() => t.remove(), 300); }, 4000);
  }
  document.getElementById('editModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeEditModal(); });
  document.getElementById('editCallModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeEditCallModal(); });
</script>

</body>
</html>
