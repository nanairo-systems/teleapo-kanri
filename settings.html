<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“</text></svg>">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¨­å®š - ãƒ†ãƒ¬ã‚¢ãƒé¡§å®¢ç®¡ç†</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<nav class="navbar">
  <div class="navbar-inner">
    <a href="index.html" class="navbar-brand"><span class="icon">ğŸ“</span>ãƒ†ãƒ¬ã‚¢ãƒé¡§å®¢ç®¡ç†</a>
    <button class="hamburger" id="hamburger"><span></span><span></span><span></span></button>
    <ul class="navbar-nav" id="navMenu">
      <li><a href="index.html">ğŸ  ãƒ›ãƒ¼ãƒ </a></li>
      <li><a href="dashboard.html">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
      <li><a href="import.html">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</a></li>
      <li><a href="settings.html" class="active">âš™ï¸ è¨­å®š</a></li>
      <li class="nav-user" id="navUserInfo"></li>
      <li><button class="btn-logout" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button></li>
    </ul>
  </div>
</nav>

<div class="loading-overlay" id="loading"><div class="spinner"></div></div>
<div class="toast-container" id="toastContainer"></div>

<div class="container" style="max-width:780px;">
  <div class="page-header">
    <h1>âš™ï¸ è¨­å®š</h1>
    <p>ã‚·ã‚¹ãƒ†ãƒ ã®æ¥ç¶šè¨­å®šã‚„å„ç¨®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ã—ã¾ã™</p>
  </div>

  <!-- Supabase æ¥ç¶šè¨­å®š -->
  <div class="card">
    <div class="card-header">
      <h2>ğŸ”— Supabase æ¥ç¶šè¨­å®š</h2>
      <p>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆSupabaseï¼‰ã¨ã®æ¥ç¶šçŠ¶æ…‹ã‚’ç¢ºèªã§ãã¾ã™</p>
    </div>
    <div class="card-body">
      <div class="form-hint" style="margin-bottom:12px;">
        æ¥ç¶šå…ˆï¼š<strong>ruyiqlgqzjotrcxxlprt.supabase.co</strong>
      </div>
      <div class="btn-group">
        <button class="btn btn-outline" onclick="testConnection()">ğŸ” æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
      </div>
      <div style="margin-top: 12px;">
        <span class="status-indicator status-unknown" id="connectionStatus">â³ æœªãƒ†ã‚¹ãƒˆ</span>
      </div>
    </div>
  </div>

  <!-- å¯¾å¿œè€…ãƒã‚¹ã‚¿ãƒ¼ -->
  <div class="card">
    <div class="card-header">
      <h2>ğŸ‘¥ å¯¾å¿œè€…ãƒã‚¹ã‚¿ãƒ¼</h2>
      <p>æ¶é›»ç™»éŒ²æ™‚ã«ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§é¸æŠã§ãã‚‹å¯¾å¿œè€…ã‚’ç®¡ç†ã—ã¾ã™</p>
    </div>
    <div class="card-body">
      <table class="list-table" id="operatorTable">
        <thead><tr><th>å¯¾å¿œè€…å</th><th>æ‹…å½“æ¥­å‹™</th><th style="width:100px;">æ“ä½œ</th></tr></thead>
        <tbody id="operatorBody"></tbody>
      </table>
      <div class="add-inline" id="operatorAdd">
        <div class="form-group">
          <label>å¯¾å¿œè€…å</label>
          <input type="text" id="newOpName" placeholder="ä¾‹ï¼šå±±ç”°å¤ªéƒ">
        </div>
        <div class="form-group" style="min-width:200px;">
          <label>æ‹…å½“æ¥­å‹™</label>
          <select id="newOpBiz" multiple style="height:auto;min-height:40px;padding:6px 8px;"></select>
        </div>
        <button class="btn btn-primary btn-sm" onclick="addOperator()">ï¼‹ è¿½åŠ </button>
      </div>
      <div class="form-hint" style="margin-top: 8px;">æ‹…å½“æ¥­å‹™ã¯ Ctrl/Cmd+ã‚¯ãƒªãƒƒã‚¯ ã§è¤‡æ•°é¸æŠã§ãã¾ã™ã€‚æœªé¸æŠãªã‚‰å…¨æ¥­å‹™ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
    </div>
  </div>

  <!-- é¡§å®¢ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ã‚°ï¼ˆæ¥­å‹™åˆ¥ï¼‰ -->
  <div class="card">
    <div class="card-header">
      <h2>ğŸ·ï¸ é¡§å®¢ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ã‚°</h2>
      <p>æ¥­å‹™ã”ã¨ã«é¡§å®¢ã«ä»˜ä¸ã™ã‚‹ã‚¿ã‚°ã‚’ç®¡ç†ã—ã¾ã™ï¼ˆé¡§å®¢è©³ç´°ç”»é¢ã§è¤‡æ•°é¸æŠå¯èƒ½ï¼‰</p>
    </div>
    <div class="card-body">
      <div class="form-group">
        <label>æ¥­å‹™ã‚’é¸æŠ</label>
        <select id="tagBizSelect" onchange="onTagBizChange()"></select>
      </div>

      <div id="tagEditor" style="display:none;">
        <div class="tag-list" id="tagList"></div>
        <div class="tag-preview" id="tagPreview"></div>
      </div>
      <div id="tagPlaceholder" style="text-align:center;padding:20px;color:var(--gray-400);">
        æ¥­å‹™ã‚’é¸æŠã—ã¦ã‚¿ã‚°ã‚’ç·¨é›†ã—ã¦ãã ã•ã„
      </div>
    </div>
  </div>

  <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰ -->
  <div class="card">
    <div class="card-header">
      <h2>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h2>
      <p>ãƒ­ã‚°ã‚¤ãƒ³ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç®¡ç†ã—ã¾ã™ã€‚ç®¡ç†è€…ã¯ã™ã¹ã¦ã®è¨­å®šã‚’å¤‰æ›´ã§ãã¾ã™</p>
    </div>
    <div class="card-body">
      <table class="list-table" id="userTable">
        <thead><tr><th>ãƒ­ã‚°ã‚¤ãƒ³ID</th><th>åå‰</th><th>æ¨©é™</th><th>è¨±å¯æ¥­å‹™</th><th style="width:120px;">æ“ä½œ</th></tr></thead>
        <tbody id="userBody"></tbody>
      </table>
      <div class="add-inline" id="userAdd">
        <div class="form-group">
          <label>ãƒ­ã‚°ã‚¤ãƒ³ID</label>
          <input type="text" id="newUserId" placeholder="ä¾‹ï¼šyamada" autocomplete="off">
        </div>
        <div class="form-group">
          <label>åå‰</label>
          <input type="text" id="newUserName" placeholder="ä¾‹ï¼šå±±ç”°å¤ªéƒ" autocomplete="off">
        </div>
        <div class="form-group" style="min-width:130px;">
          <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="password" id="newUserPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="new-password">
        </div>
        <div class="form-group" style="min-width:110px;">
          <label>æ¨©é™</label>
          <select id="newUserRole">
            <option value="staff">ğŸ‘¤ ã‚¹ã‚¿ãƒƒãƒ•</option>
            <option value="admin">ğŸ”‘ ç®¡ç†è€…</option>
          </select>
        </div>
        <button class="btn btn-primary btn-sm" onclick="addUser()">ï¼‹ è¿½åŠ </button>
      </div>
      <div class="form-hint" style="margin-top:8px;">
        â€» ç®¡ç†è€…ã¯è¨­å®šç”»é¢ã®å…¨æ©Ÿèƒ½ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ã‚¹ã‚¿ãƒƒãƒ•ã¯é¡§å®¢ç®¡ç†ãƒ»æ¶é›»ã®ã¿åˆ©ç”¨ã§ãã¾ã™ã€‚
      </div>
    </div>
  </div>

  <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ -->
  <div class="card">
    <div class="card-header"><h2>ğŸ“– ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰</h2><p>åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®æ‰‹é †</p></div>
    <div class="card-body">
      <ol class="setup-steps">
        <li><strong>Supabaseã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ</strong><br><code>supabase.com</code> ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™</li>
        <li><strong>ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ</strong><br>Supabaseç®¡ç†ç”»é¢ã®ã€ŒSQL Editorã€ã§ <code>supabase-schema.sql</code> ã®å†…å®¹ã‚’å®Ÿè¡Œã—ã¾ã™</li>
        <li><strong>æ¥ç¶šãƒ†ã‚¹ãƒˆ</strong><br>ã€Œæ¥ç¶šãƒ†ã‚¹ãƒˆã€ãƒœã‚¿ãƒ³ã§ã€Œæ¥ç¶šOKã€ã¨è¡¨ç¤ºã•ã‚Œã‚Œã°å®Œäº†ã§ã™</li>
      </ol>
    </div>
  </div>

  <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
  <div class="card">
    <div class="card-header"><h2>ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2></div>
    <div class="card-body">
      <div class="btn-group">
        <button class="btn btn-outline" onclick="exportData()">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆCSVï¼‰</button>
        <button class="btn btn-danger-outline" onclick="clearLocalData()">ğŸ—‘ï¸ ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
      <div class="form-hint" style="margin-top: 8px;">â€» ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®šã®ãƒªã‚»ãƒƒãƒˆã¯GAS URLãƒ»å¯¾å¿œè€…ãƒ»ã‚¿ã‚°ãƒ»æ¥­å‹™ä¸€è¦§ãªã©ã®ãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®ã¿å‰Šé™¤ã—ã¾ã™ã€‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã¯å½±éŸ¿ã—ã¾ã›ã‚“ã€‚</div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase-api.js"></script>
<script>
  // â”€â”€ èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰ â”€â”€
  (function() {
    const a = JSON.parse(localStorage.getItem('authSession') || 'null');
    if (!a || Date.now() > a.expiry) { localStorage.removeItem('authSession'); location.replace('login.html'); return; }
    if (a.role !== 'admin') { alert('ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™'); location.replace('index.html'); }
  })();

  function logout() {
    if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.removeItem('authSession'); location.href = 'login.html'; }
  }

  const DEFAULT_TAGS = ['è¦‹è¾¼ã¿é«˜', 'è¦‹è¾¼ã¿ä½', 'ã‚¢ãƒæ¸ˆã¿', 'æ–­ã‚Š', 'è¦ãƒ•ã‚©ãƒ­ãƒ¼'];
  const MAX_TAGS = 10;

  let operators = [];
  let customTags = [];
  let users = [];

  async function saveAppSetting(key, value) {
    await syncSettingToSupabase(key, value);
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const auth = JSON.parse(localStorage.getItem('authSession') || 'null');
    if (auth) { const el = document.getElementById('navUserInfo'); if (el) el.textContent = `ğŸ‘¤ ${auth.name}`; }
    await syncSettingsFromSupabase();
    loadOperators();
    loadUsers();
    loadTags();
    populateBizSelect();
    document.getElementById('hamburger').addEventListener('click', () => {
      document.getElementById('navMenu').classList.toggle('open');
    });
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Supabase æ¥ç¶šãƒ†ã‚¹ãƒˆ
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function testConnection() {
    setStatus('unknown', 'â³ ãƒ†ã‚¹ãƒˆä¸­...');
    showLoading(true);
    try {
      await apiPing();
      setStatus('ok', 'âœ… æ¥ç¶šOK');
      showToast('Supabaseæ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸï¼', 'success');
    } catch(e) {
      setStatus('ng', 'âŒ æ¥ç¶šå¤±æ•—');
      showToast('æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'error');
    } finally { showLoading(false); }
  }

  function setStatus(type, text) { const el = document.getElementById('connectionStatus'); el.className = `status-indicator status-${type}`; el.textContent = text; }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // å¯¾å¿œè€…ãƒã‚¹ã‚¿ãƒ¼
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function loadOperators() {
    operators = JSON.parse(localStorage.getItem('operators') || '[]');
    renderOperators();
  }

  function saveOperators() { saveAppSetting('operators', operators); }

  function populateBizSelect() {
    const businesses = JSON.parse(localStorage.getItem('businesses') || '[]');
    const sel = document.getElementById('newOpBiz');
    sel.innerHTML = businesses.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
  }

  function renderOperators() {
    const body = document.getElementById('operatorBody');
    const businesses = JSON.parse(localStorage.getItem('businesses') || '[]');
    if (operators.length === 0) {
      body.innerHTML = '<tr><td colspan="3" class="empty-row">å¯¾å¿œè€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>';
      return;
    }
    body.innerHTML = operators.map((op, i) => {
      const bizNames = (op.businessIds || []).map(bid => {
        const b = businesses.find(x => x.id === bid);
        return b ? `<span class="biz-chip">${b.icon} ${b.name}</span>` : '';
      }).filter(Boolean).join('');
      return `<tr>
        <td><strong>${esc(op.name)}</strong></td>
        <td><div class="biz-chips">${bizNames || '<span style="color:var(--gray-400);font-size:12px;">å…¨æ¥­å‹™</span>'}</div></td>
        <td class="actions">
          <button class="btn btn-outline btn-sm" onclick="editOperator(${i})">âœï¸</button>
          <button class="btn btn-danger-outline btn-sm" onclick="deleteOperator(${i})">ğŸ—‘ï¸</button>
        </td>
      </tr>`;
    }).join('');
  }

  function addOperator() {
    const name = document.getElementById('newOpName').value.trim();
    if (!name) { showToast('å¯¾å¿œè€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    const sel = document.getElementById('newOpBiz');
    const bizIds = Array.from(sel.selectedOptions).map(o => o.value);
    operators.push({ id: Date.now().toString(36), name, businessIds: bizIds });
    saveOperators(); renderOperators();
    document.getElementById('newOpName').value = '';
    sel.selectedIndex = -1;
    showToast(`${name} ã‚’è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
  }

  function editOperator(idx) {
    const op = operators[idx];
    const newName = prompt('å¯¾å¿œè€…åã‚’ç·¨é›†', op.name);
    if (newName === null) return;
    if (!newName.trim()) { showToast('åå‰ã¯ç©ºã«ã§ãã¾ã›ã‚“', 'error'); return; }
    op.name = newName.trim();
    saveOperators(); renderOperators();
    showToast('å¯¾å¿œè€…ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
  }

  function deleteOperator(idx) {
    if (!confirm(`ã€Œ${operators[idx].name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    operators.splice(idx, 1);
    saveOperators(); renderOperators();
    showToast('å¯¾å¿œè€…ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // é¡§å®¢ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ã‚°ï¼ˆæ¥­å‹™åˆ¥ï¼‰
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let selectedTagBizId = '';

  function loadTags() { populateTagBizSelect(); }

  function populateTagBizSelect() {
    const businesses = JSON.parse(localStorage.getItem('businesses') || '[]');
    const sel = document.getElementById('tagBizSelect');
    sel.innerHTML = '<option value="">-- æ¥­å‹™ã‚’é¸æŠ --</option>' +
      businesses.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
  }

  function onTagBizChange() {
    selectedTagBizId = document.getElementById('tagBizSelect').value;
    if (selectedTagBizId) {
      customTags = getTagsForBusiness(selectedTagBizId);
      document.getElementById('tagEditor').style.display = '';
      document.getElementById('tagPlaceholder').style.display = 'none';
      renderTags();
    } else {
      document.getElementById('tagEditor').style.display = 'none';
      document.getElementById('tagPlaceholder').style.display = '';
    }
  }

  function getTagsForBusiness(bizId) {
    const allTags = JSON.parse(localStorage.getItem('customerTagsByBusiness') || '{}');
    return allTags[bizId] || [...DEFAULT_TAGS];
  }

  function saveTags() {
    if (!selectedTagBizId) return;
    const allTags = JSON.parse(localStorage.getItem('customerTagsByBusiness') || '{}');
    allTags[selectedTagBizId] = customTags;
    saveAppSetting('customerTagsByBusiness', allTags);
    renderTagPreview();
  }

  function renderTags() {
    const list = document.getElementById('tagList');
    list.innerHTML = customTags.map((tag, i) => `
      <div class="tag-row">
        <span class="tag-label">ã‚¿ã‚°${i + 1}</span>
        <div class="tag-editable">
          <input type="text" value="${esc(tag)}" onchange="updateTag(${i}, this.value)" onblur="updateTag(${i}, this.value)">
          <button class="tag-remove" onclick="removeTag(${i})">&times;</button>
        </div>
      </div>
    `).join('') +
    (customTags.length < MAX_TAGS ? `
      <div class="tag-row">
        <span class="tag-label"></span>
        <button class="btn btn-outline btn-sm" onclick="addTag()">ï¼‹ ã‚¿ã‚°ã‚’è¿½åŠ ï¼ˆæ®‹ã‚Š${MAX_TAGS - customTags.length}ï¼‰</button>
      </div>
    ` : '');
    renderTagPreview();
  }

  function updateTag(idx, value) {
    value = value.trim();
    if (!value) { showToast('ã‚¿ã‚°åã¯ç©ºã«ã§ãã¾ã›ã‚“', 'error'); renderTags(); return; }
    customTags[idx] = value;
    saveTags();
  }

  function addTag() {
    if (customTags.length >= MAX_TAGS) { showToast(`ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚°ã¯${MAX_TAGS}ã¤ã¾ã§ã§ã™`, 'error'); return; }
    customTags.push('æ–°ã—ã„ã‚¿ã‚°');
    saveTags(); renderTags();
  }

  function removeTag(idx) {
    if (!confirm(`ã€Œ${customTags[idx]}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    customTags.splice(idx, 1);
    saveTags(); renderTags();
    showToast('ã‚¿ã‚°ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
  }

  function renderTagPreview() {
    const businesses = JSON.parse(localStorage.getItem('businesses') || '[]');
    const biz = businesses.find(b => b.id === selectedTagBizId);
    const bizLabel = biz ? `${biz.icon} ${biz.name}` : '';
    document.getElementById('tagPreview').innerHTML = `
      <div class="tag-preview-title">é¡§å®¢è©³ç´°ç”»é¢ã§ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼${bizLabel ? `ï¼ˆ${bizLabel}ï¼‰` : ''}:</div>
      ${customTags.map(t => `<span class="tag-chip">${esc(t)}</span>`).join('')}
    `;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password + '_teleapo_v1');
    const hash = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
  }

  function loadUsers() {
    users = JSON.parse(localStorage.getItem('users') || '[]');
    renderUsers();
  }

  function saveUsers() { saveAppSetting('users', users); }

  function renderUsers() {
    const body = document.getElementById('userBody');
    const auth = JSON.parse(localStorage.getItem('authSession') || 'null');
    const allBiz = JSON.parse(localStorage.getItem('businesses') || '[]');
    if (users.length === 0) {
      body.innerHTML = '<tr><td colspan="5" class="empty-row">ãƒ¦ãƒ¼ã‚¶ãƒ¼æœªç™»éŒ²ï¼ˆåˆæœŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼šadmin / admin123ï¼‰</td></tr>';
      return;
    }
    body.innerHTML = users.map((u, i) => {
      const allowed = u.allowedBusinesses || [];
      const bizNames = u.role === 'admin' ? '<em style="color:var(--gray-400)">å…¨æ¥­å‹™</em>'
        : allowed.length === 0 ? '<em style="color:var(--gray-400)">å…¨æ¥­å‹™</em>'
        : allowed.map(bid => { const b = allBiz.find(x => x.id === bid); return b ? esc(b.name) : bid; }).join(', ');
      return `<tr>
      <td><code style="background:var(--gray-100);padding:2px 6px;border-radius:4px;">${esc(u.loginId)}</code></td>
      <td>${esc(u.name)}</td>
      <td>${u.role === 'admin' ? 'ğŸ”‘ ç®¡ç†è€…' : 'ğŸ‘¤ ã‚¹ã‚¿ãƒƒãƒ•'}</td>
      <td style="font-size:12px;max-width:200px;">${bizNames}${u.role !== 'admin' ? ` <button class="btn btn-outline btn-sm" onclick="editAllowedBiz(${i})" style="padding:2px 6px;font-size:11px;">å¤‰æ›´</button>` : ''}</td>
      <td class="actions">
        <button class="btn btn-outline btn-sm" onclick="changePassword(${i})" title="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´">ğŸ”‘</button>
        ${u.loginId !== auth?.userId ? `<button class="btn btn-danger-outline btn-sm" onclick="deleteUser(${i})" title="å‰Šé™¤">ğŸ—‘ï¸</button>` : '<span style="font-size:12px;color:var(--gray-400);padding:0 6px;">ï¼ˆè‡ªåˆ†ï¼‰</span>'}
      </td>
    </tr>`;
    }).join('');
  }

  function editAllowedBiz(idx) {
    const u = users[idx];
    const allBiz = JSON.parse(localStorage.getItem('businesses') || '[]');
    const current = u.allowedBusinesses || [];
    const choices = allBiz.map(b => `${current.includes(b.id) ? 'âœ…' : 'â¬œ'} ${b.name}`).join('\n');
    const input = prompt(`ã€Œ${u.name}ã€ã®è¨±å¯æ¥­å‹™ã‚’ç•ªå·ã§å…¥åŠ›\nï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€ç©º=å…¨æ¥­å‹™ï¼‰\n\n` +
      allBiz.map((b, i) => `${i+1}. ${b.name} ${current.includes(b.id) ? 'âœ…' : ''}`).join('\n'));
    if (input === null) return;
    if (input.trim() === '') {
      u.allowedBusinesses = [];
    } else {
      const nums = input.split(/[,ã€\s]+/).map(n => parseInt(n)).filter(n => !isNaN(n) && n >= 1 && n <= allBiz.length);
      u.allowedBusinesses = nums.map(n => allBiz[n-1].id);
    }
    saveUsers(); renderUsers();
    showToast('è¨±å¯æ¥­å‹™ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
  }

  async function addUser() {
    const loginId  = document.getElementById('newUserId').value.trim();
    const name     = document.getElementById('newUserName').value.trim();
    const password = document.getElementById('newUserPassword').value;
    const role     = document.getElementById('newUserRole').value;
    if (!loginId || !name || !password) { showToast('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    if (users.find(u => u.loginId === loginId)) { showToast('ãã®IDã¯ã™ã§ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™', 'error'); return; }
    if (password.length < 4) { showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„', 'error'); return; }
    const hashed = await hashPassword(password);
    users.push({ loginId, name, password: hashed, role });
    saveUsers(); renderUsers();
    document.getElementById('newUserId').value = '';
    document.getElementById('newUserName').value = '';
    document.getElementById('newUserPassword').value = '';
    showToast(`${name} ã‚’è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
  }

  async function changePassword(idx) {
    const newPass = prompt(`ã€Œ${users[idx].name}ã€ã®æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`);
    if (newPass === null) return;
    if (!newPass.trim() || newPass.length < 4) { showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„', 'error'); return; }
    users[idx].password = await hashPassword(newPass);
    saveUsers();
    showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ', 'success');
  }

  function deleteUser(idx) {
    if (!confirm(`ã€Œ${users[idx].name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    users.splice(idx, 1);
    saveUsers(); renderUsers();
    showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ãƒ‡ãƒ¼ã‚¿ç®¡ç†
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function exportData() {
    showLoading(true);
    try {
      const data = await apiGetCustomers();
      const customers = data.customers || [];
      if (customers.length === 0) { showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error'); return; }

      const headers = ['ID', 'æ¥­å‹™ID', 'ä¼šç¤¾å', 'æ‹…å½“è€…', 'éƒ¨ç½²', 'é›»è©±ç•ªå·', 'ãƒ¡ãƒ¼ãƒ«', 'ä½æ‰€', 'ã‚¿ã‚°', 'æ¶é›»å›æ•°', 'æœ€çµ‚æ¶é›»æ—¥', 'å‚™è€ƒ', 'ç™»éŒ²æ—¥', 'æ›´æ–°æ—¥'];
      const rows = customers.map(c => [c.id, c.businessId, c.companyName, c.contactName, c.department, c.phone, c.email, c.address, c.tags, c.callCount, c.lastCallDate, c.notes, c.createdAt, c.updatedAt]);
      const bom = '\uFEFF';
      const csv = bom + [headers, ...rows].map(r => r.map(v => `"${String(v || '').replace(/"/g, '""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = `é¡§å®¢ãƒ‡ãƒ¼ã‚¿_${new Date().toISOString().slice(0,10)}.csv`;
      a.click(); URL.revokeObjectURL(a.href);
      showToast('CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
    } catch (e) { showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'error'); }
    finally { showLoading(false); }
  }

  function clearLocalData() {
    if (!confirm('ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nSupabaseã®ãƒ‡ãƒ¼ã‚¿ã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ã€‚')) return;
    ['businesses','operators','callResultTags','callResultTagsByBusiness',
     'customerTagsByBusiness','lastOperatorId','gasApiUrl'].forEach(k => localStorage.removeItem(k));
    setStatus('unknown', 'â³ æœªãƒ†ã‚¹ãƒˆ');
    operators = []; customTags = [...DEFAULT_TAGS]; selectedTagBizId = '';
    renderOperators(); populateBizSelect(); populateTagBizSelect();
    document.getElementById('tagEditor').style.display = 'none';
    document.getElementById('tagPlaceholder').style.display = '';
    showToast('ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'success');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
  function showLoading(v) { document.getElementById('loading').classList.toggle('show', v); }
  function showToast(msg, type = 'success') {
    const c = document.getElementById('toastContainer'); const t = document.createElement('div'); t.className = `toast ${type}`;
    t.innerHTML = `<span>${type==='success'?'âœ…':'âŒ'}</span> ${esc(msg)}`;
    c.appendChild(t); setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(() => t.remove(), 300); }, 4000);
  }
</script>

</body>
</html>
