<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¶é›»ç™»éŒ² - ãƒ†ãƒ¬ã‚¢ãƒé¡§å®¢ç®¡ç†</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<nav class="navbar">
  <div class="navbar-inner">
    <a href="index.html" class="navbar-brand"><span class="icon">ğŸ“</span>ãƒ†ãƒ¬ã‚¢ãƒé¡§å®¢ç®¡ç†</a>
    <ul class="navbar-nav">
      <li><a href="index.html">ğŸ  ãƒ›ãƒ¼ãƒ </a></li>
      <li><a href="#" id="navCustomers">ğŸ“‹ é¡§å®¢ä¸€è¦§</a></li>
      <li><a href="#" class="active" id="navCall">ğŸ“ æ¶é›»ç™»éŒ²</a></li>
      <li><a href="import.html">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</a></li>
      <li><a href="settings.html">âš™ï¸ è¨­å®š</a></li>
    </ul>
  </div>
</nav>

<div class="loading-overlay" id="loading"><div class="spinner"></div></div>
<div class="toast-container" id="toastContainer"></div>

<div class="container" style="max-width:800px;">
  <div class="breadcrumb">
    <a href="index.html">ãƒ›ãƒ¼ãƒ </a><span>â€º</span>
    <a href="#" id="bcBiz">æ¥­å‹™</a><span>â€º</span>
    <span>æ¶é›»ç™»éŒ²</span>
  </div>

  <div class="page-header">
    <h1>ğŸ“ æ¶é›»ç™»éŒ²</h1>
    <p>æ¶é›»çµæœã‚’è¨˜éŒ²ã—ã¾ã™</p>
  </div>

  <form id="callForm" onsubmit="return handleSubmit(event)">
    <!-- é¡§å®¢é¸æŠ -->
    <div class="card">
      <div class="card-header"><h2>ğŸ‘¤ é¡§å®¢ã‚’é¸æŠ</h2></div>
      <div class="card-body">
        <div class="form-group">
          <label>å¯¾è±¡é¡§å®¢<span class="required">*</span></label>
          <div class="customer-select-box">
            <input type="text" class="customer-search-input" id="customerSearch" placeholder="ä¼šç¤¾åãƒ»æ‹…å½“è€…åã§æ¤œç´¢..." autocomplete="off" oninput="handleCustomerSearch()" onfocus="handleCustomerSearch()">
            <div class="customer-dropdown" id="customerDropdown"></div>
          </div>
          <div class="selected-customer" id="selectedCustomer">
            <div class="sc-info"><span class="sc-name" id="scName"></span><span class="sc-detail" id="scDetail"></span></div>
            <button type="button" class="sc-remove" onclick="clearCustomer()">&times;</button>
          </div>
          <input type="hidden" id="selectedCustomerId" name="customerId" required>
        </div>
      </div>
    </div>

    <!-- é€šè©±ã‚¿ã‚¤ãƒãƒ¼ -->
    <div class="card">
      <div class="card-header"><h2>â±ï¸ é€šè©±ã‚¿ã‚¤ãƒãƒ¼</h2></div>
      <div class="card-body">
        <div class="timer-section">
          <div class="timer-display" id="timerDisplay">00:00</div>
          <div class="timer-buttons">
            <button type="button" class="btn btn-success" id="timerStart" onclick="startTimer()">â–¶ é–‹å§‹</button>
            <button type="button" class="btn btn-outline" id="timerStop" onclick="stopTimer()" style="display:none;">â¸ åœæ­¢</button>
            <button type="button" class="btn btn-outline" id="timerReset" onclick="resetTimer()">â†» ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </div>
        <input type="hidden" id="callDuration" name="duration">
      </div>
    </div>

    <!-- æ¶é›»çµæœï¼ˆè¤‡æ•°é¸æŠã‚¿ã‚°ï¼‰ -->
    <div class="card">
      <div class="card-header"><h2>ğŸ“ æ¶é›»çµæœ</h2></div>
      <div class="card-body">
        <div class="form-group">
          <label>æ¶é›»çµæœã‚¿ã‚°<span class="required">*</span>ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
          <div class="tag-buttons" id="tagButtons">
            <!-- JSã§æç”» -->
          </div>
          <div class="selected-tags-display" id="selectedTagsDisplay"></div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>æ¶é›»æ—¥æ™‚</label>
            <input type="datetime-local" id="callDate" name="callDate">
          </div>
          <div class="form-group">
            <label>å¯¾å¿œè€…<span class="required">*</span></label>
            <select id="operatorSelect" name="operator">
              <option value="">-- å¯¾å¿œè€…ã‚’é¸æŠ --</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>ãƒ¡ãƒ¢</label>
          <textarea name="memo" id="callMemo" placeholder="é€šè©±å†…å®¹ã‚„æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãªã©ã‚’è¨˜éŒ²..."></textarea>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <a href="#" class="btn btn-outline" id="cancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
      <button type="submit" class="btn btn-primary btn-lg">ğŸ’¾ æ¶é›»çµæœã‚’ç™»éŒ²</button>
    </div>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase-api.js"></script>
<script>
  // â”€â”€ èªè¨¼ãƒã‚§ãƒƒã‚¯ â”€â”€
  (function() {
    const a = JSON.parse(localStorage.getItem('authSession') || 'null');
    if (!a || Date.now() > a.expiry) { localStorage.removeItem('authSession'); location.replace('login.html'); }
  })();

  const FIXED_LEFT = 'ã‚¢ãƒç²å¾—';
  const FIXED_RIGHT = 'æ¥­ç¨®ä¸ä¸€è‡´';

  let customers = [];
  let selectedCustomer = null;
  let timerInterval = null;
  let timerSeconds = 0;
  let timerRunning = false;
  let businessId = '';
  let selectedTags = new Set();

  document.addEventListener('DOMContentLoaded', () => {
    const p = new URLSearchParams(window.location.search);
    businessId = p.get('businessId') || '';
    if (!businessId) { window.location.href = 'index.html'; return; }

    updateNavLinks();
    renderTagButtons();
    populateOperators();

    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('callDate').value = now.toISOString().slice(0, 16);

    loadCustomers();
  });

  function updateNavLinks() {
    const biz = encodeURIComponent(businessId);
    document.getElementById('navCustomers').href = `customers.html?businessId=${biz}`;
    document.getElementById('navCall').href = `call.html?businessId=${biz}`;
    document.getElementById('bcBiz').href = `customers.html?businessId=${biz}`;
    document.getElementById('cancelBtn').href = `customers.html?businessId=${biz}`;
    const businesses = JSON.parse(localStorage.getItem('businesses') || '[]');
    const b = businesses.find(x => x.id === businessId);
    if (b) document.getElementById('bcBiz').textContent = b.name;
  }

  // â”€â”€ æ¶é›»çµæœã‚¿ã‚°ï¼ˆè¤‡æ•°é¸æŠãƒ»æ¥­å‹™åˆ¥ï¼‰ â”€â”€
  function renderTagButtons() {
    const tagsByBiz = JSON.parse(localStorage.getItem('callResultTagsByBusiness') || '{}');
    const middleTags = tagsByBiz[businessId] || ['æ‹…å½“è€…ä¸åœ¨', 'ä¸åœ¨', 'å†æ¶é›»', 'è³‡æ–™é€ä»˜', 'æ–­ã‚Š'];
    const allTags = [FIXED_LEFT, ...middleTags, FIXED_RIGHT];
    const container = document.getElementById('tagButtons');

    container.innerHTML = allTags.map((tag, i) => {
      let cls = 'tag-btn';
      if (i === 0) cls += ' tag-first';
      if (i === allTags.length - 1) cls += ' tag-last';
      return `<button type="button" class="${cls}" data-tag="${esc(tag)}" onclick="toggleTag(this)">${esc(tag)}</button>`;
    }).join('');
  }

  function toggleTag(btn) {
    const tag = btn.dataset.tag;
    if (selectedTags.has(tag)) {
      selectedTags.delete(tag);
      btn.classList.remove('selected');
    } else {
      selectedTags.add(tag);
      btn.classList.add('selected');
    }
    updateTagsDisplay();
  }

  function updateTagsDisplay() {
    const display = document.getElementById('selectedTagsDisplay');
    if (selectedTags.size === 0) {
      display.textContent = '';
    } else {
      display.textContent = `é¸æŠä¸­: ${[...selectedTags].join('ã€')}`;
    }
  }

  // â”€â”€ å¯¾å¿œè€…ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ â”€â”€
  function populateOperators() {
    const operators = JSON.parse(localStorage.getItem('operators') || '[]');
    const sel = document.getElementById('operatorSelect');

    const filtered = operators.filter(op => {
      if (!op.businessIds || op.businessIds.length === 0) return true;
      return op.businessIds.includes(businessId);
    });

    sel.innerHTML = '<option value="">-- å¯¾å¿œè€…ã‚’é¸æŠ --</option>' +
      filtered.map(op => `<option value="${esc(op.name)}" data-id="${op.id}">${esc(op.name)}</option>`).join('');

    const lastOpId = localStorage.getItem('lastOperatorId');
    if (lastOpId) {
      const opt = sel.querySelector(`option[data-id="${lastOpId}"]`);
      if (opt) opt.selected = true;
    }
  }

  // â”€â”€ é¡§å®¢ â”€â”€
  async function loadCustomers() {
    try {
      const data = await apiGetCustomers(businessId);
      customers = data.customers || [];
      const preselect = new URLSearchParams(window.location.search).get('customerId');
      if (preselect) { const c = customers.find(x => x.id === preselect); if (c) selectCustomer(c); }
    } catch(e) { console.error('[loadCustomers]', e); }
  }

  function handleCustomerSearch() {
    const query = document.getElementById('customerSearch').value.toLowerCase().trim();
    const dropdown = document.getElementById('customerDropdown');
    if (!query || customers.length === 0) { dropdown.classList.remove('show'); return; }
    const matches = customers.filter(c => (c.companyName || '').toLowerCase().includes(query) || (c.contactName || '').toLowerCase().includes(query)).slice(0, 20);
    if (matches.length === 0) {
      dropdown.innerHTML = '<div style="padding:12px;color:var(--gray-400);font-size:14px;text-align:center;">è©²å½“ãªã—</div>';
    } else {
      dropdown.innerHTML = matches.map(c => `<div class="customer-option" onclick='selectCustomer(${JSON.stringify(c).replace(/'/g, "&#39;")})'><div><div class="co-name">${esc(c.companyName)}</div><div class="co-sub">${esc(c.contactName || '')} ${esc(c.phone || '')}</div></div></div>`).join('');
    }
    dropdown.classList.add('show');
  }

  function selectCustomer(c) {
    selectedCustomer = c;
    document.getElementById('selectedCustomerId').value = c.id;
    document.getElementById('scName').textContent = c.companyName;
    document.getElementById('scDetail').textContent = `${c.contactName || '-'} / ${c.phone || '-'}`;
    document.getElementById('selectedCustomer').classList.add('show');
    document.getElementById('customerSearch').style.display = 'none';
    document.getElementById('customerDropdown').classList.remove('show');
  }

  function clearCustomer() {
    selectedCustomer = null;
    document.getElementById('selectedCustomerId').value = '';
    document.getElementById('selectedCustomer').classList.remove('show');
    document.getElementById('customerSearch').style.display = '';
    document.getElementById('customerSearch').value = '';
  }

  // â”€â”€ ã‚¿ã‚¤ãƒãƒ¼ â”€â”€
  function startTimer() {
    if (timerRunning) return;
    timerRunning = true;
    document.getElementById('timerDisplay').classList.add('active');
    document.getElementById('timerStart').style.display = 'none';
    document.getElementById('timerStop').style.display = '';
    timerInterval = setInterval(() => { timerSeconds++; updateTimerDisplay(); }, 1000);
  }
  function stopTimer() {
    timerRunning = false; clearInterval(timerInterval);
    document.getElementById('timerDisplay').classList.remove('active');
    document.getElementById('timerStart').style.display = '';
    document.getElementById('timerStop').style.display = 'none';
    document.getElementById('callDuration').value = formatTimer(timerSeconds);
  }
  function resetTimer() { stopTimer(); timerSeconds = 0; updateTimerDisplay(); document.getElementById('callDuration').value = ''; }
  function updateTimerDisplay() { document.getElementById('timerDisplay').textContent = formatTimer(timerSeconds); }
  function formatTimer(sec) { return `${String(Math.floor(sec / 60)).padStart(2, '0')}:${String(sec % 60).padStart(2, '0')}`; }

  // â”€â”€ é€ä¿¡ â”€â”€
  async function handleSubmit(event) {
    event.preventDefault();
    const customerId = document.getElementById('selectedCustomerId').value;
    if (!customerId) { showToast('é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return false; }
    if (selectedTags.size === 0) { showToast('æ¶é›»çµæœã‚¿ã‚°ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„', 'error'); return false; }

    const sel = document.getElementById('operatorSelect');
    if (!sel.value) { showToast('å¯¾å¿œè€…ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return false; }

    if (timerRunning) stopTimer();

    const selectedOpt = sel.selectedOptions[0];
    if (selectedOpt && selectedOpt.dataset.id) localStorage.setItem('lastOperatorId', selectedOpt.dataset.id);

    showLoading(true);
    try {
      await apiAddCallRecord({
        customerId,
        callDate:  document.getElementById('callDate').value,
        result:    [...selectedTags].join(','),
        duration:  document.getElementById('callDuration').value || formatTimer(timerSeconds),
        operator:  sel.value,
        memo:      document.getElementById('callMemo').value.trim(),
      });
      showToast('æ¶é›»çµæœã‚’ç™»éŒ²ã—ã¾ã—ãŸ âœ…', 'success');
      setTimeout(() => {
        window.location.href = `detail.html?id=${encodeURIComponent(customerId)}&businessId=${encodeURIComponent(businessId)}`;
      }, 1000);
    } catch(e) {
      console.error('[handleSubmit]', e);
      showToast('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e.message || String(e)), 'error');
    } finally { showLoading(false); }
    return false;
  }

  function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
  function showLoading(v) { document.getElementById('loading').classList.toggle('show', v); }
  function showToast(msg, type = 'success') {
    const c = document.getElementById('toastContainer'); const t = document.createElement('div'); t.className = `toast ${type}`;
    t.innerHTML = `<span>${type==='success'?'âœ…':'âŒ'}</span> ${esc(msg)}`;
    c.appendChild(t); setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(() => t.remove(), 300); }, 4000);
  }
  document.addEventListener('click', e => { if (!e.target.closest('.customer-select-box')) document.getElementById('customerDropdown').classList.remove('show'); });
</script>

</body>
</html>
