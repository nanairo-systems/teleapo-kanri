<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¶é›»ç™»éŒ² - ãƒ†ãƒ¬ã‚¢ãƒé¡§å®¢ç®¡ç†</title>
  <style>
    :root {
      --primary: #2563eb; --primary-hover: #1d4ed8; --success: #16a34a;
      --warning: #f59e0b; --danger: #dc2626; --info: #0891b2;
      --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
      --gray-300: #d1d5db; --gray-400: #9ca3af; --gray-500: #6b7280;
      --gray-600: #4b5563; --gray-700: #374151; --gray-800: #1f2937;
      --gray-900: #111827; --radius: 8px;
      --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; background: var(--gray-50); color: var(--gray-800); line-height: 1.6; }

    .navbar { background: #fff; border-bottom: 1px solid var(--gray-200); padding: 0 24px; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); }
    .navbar-inner { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; height: 56px; }
    .navbar-brand { font-size: 18px; font-weight: 700; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 8px; }
    .navbar-brand .icon { font-size: 22px; }
    .navbar-nav { display: flex; gap: 4px; list-style: none; }
    .navbar-nav a { display: flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: var(--radius); text-decoration: none; color: var(--gray-600); font-size: 14px; font-weight: 500; transition: background 0.15s, color 0.15s; }
    .navbar-nav a:hover { background: var(--gray-100); color: var(--gray-800); }
    .navbar-nav a.active { background: #eff6ff; color: var(--primary); }

    .container { max-width: 800px; margin: 0 auto; padding: 24px; }
    .breadcrumb { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--gray-500); margin-bottom: 20px; flex-wrap: wrap; }
    .breadcrumb a { color: var(--primary); text-decoration: none; }
    .breadcrumb a:hover { text-decoration: underline; }
    .page-header { margin-bottom: 24px; }
    .page-header h1 { font-size: 22px; font-weight: 700; color: var(--gray-900); }
    .page-header p { font-size: 14px; color: var(--gray-500); margin-top: 4px; }

    .card { background: #fff; border: 1px solid var(--gray-200); border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; }
    .card-header { padding: 16px 20px; border-bottom: 1px solid var(--gray-200); }
    .card-header h2 { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .card-body { padding: 20px; }

    .customer-select-box { position: relative; }
    .customer-search-input { width: 100%; padding: 10px 14px; border: 1px solid var(--gray-300); border-radius: var(--radius); font-size: 14px; outline: none; transition: border-color 0.15s; }
    .customer-search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
    .customer-dropdown { display: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid var(--gray-200); border-radius: var(--radius); box-shadow: var(--shadow-md); max-height: 240px; overflow-y: auto; z-index: 10; margin-top: 4px; }
    .customer-dropdown.show { display: block; }
    .customer-option { padding: 10px 14px; cursor: pointer; font-size: 14px; border-bottom: 1px solid var(--gray-100); }
    .customer-option:last-child { border-bottom: none; }
    .customer-option:hover { background: #eff6ff; }
    .customer-option .co-name { font-weight: 600; color: var(--gray-800); }
    .customer-option .co-sub { font-size: 12px; color: var(--gray-500); }
    .selected-customer { display: none; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: var(--radius); padding: 12px 16px; margin-top: 8px; align-items: center; justify-content: space-between; }
    .selected-customer.show { display: flex; }
    .selected-customer .sc-info { display: flex; flex-direction: column; }
    .selected-customer .sc-name { font-weight: 600; color: var(--gray-800); font-size: 15px; }
    .selected-customer .sc-detail { font-size: 13px; color: var(--gray-500); }
    .sc-remove { background: none; border: none; font-size: 18px; cursor: pointer; color: var(--gray-400); padding: 4px 8px; border-radius: 4px; }
    .sc-remove:hover { background: rgba(0,0,0,0.05); color: var(--gray-700); }

    .form-group { margin-bottom: 18px; }
    .form-group label { display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px; }
    .form-group label .required { color: var(--danger); margin-left: 2px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 14px; border: 1px solid var(--gray-300); border-radius: var(--radius); font-size: 14px; font-family: inherit; outline: none; transition: border-color 0.15s; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
    .form-group textarea { resize: vertical; min-height: 120px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

    /* â”€â”€ è¤‡æ•°é¸æŠã‚¿ã‚° â”€â”€ */
    .tag-buttons { display: flex; flex-wrap: wrap; gap: 8px; }
    .tag-btn {
      padding: 8px 18px; border: 2px solid var(--gray-200); border-radius: 999px;
      background: #fff; font-size: 14px; font-weight: 500; cursor: pointer;
      transition: all 0.15s; color: var(--gray-600); user-select: none;
    }
    .tag-btn:hover { border-color: var(--gray-400); }
    .tag-btn.selected { border-color: var(--primary); background: #eff6ff; color: var(--primary); font-weight: 600; }
    .tag-btn.tag-first.selected { border-color: var(--success); background: #dcfce7; color: #166534; }
    .tag-btn.tag-last.selected { border-color: var(--danger); background: #fee2e2; color: #991b1b; }
    .selected-tags-display { margin-top: 8px; font-size: 13px; color: var(--gray-500); }

    .timer-section { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
    .timer-display { font-size: 32px; font-weight: 700; font-variant-numeric: tabular-nums; color: var(--gray-800); min-width: 120px; }
    .timer-display.active { color: var(--primary); }
    .timer-buttons { display: flex; gap: 8px; }

    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 18px; border: none; border-radius: var(--radius); font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.15s, transform 0.1s; text-decoration: none; white-space: nowrap; }
    .btn:active { transform: scale(0.97); }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-success { background: var(--success); color: #fff; }
    .btn-success:hover { background: #15803d; }
    .btn-outline { background: #fff; color: var(--gray-700); border: 1px solid var(--gray-300); }
    .btn-outline:hover { background: var(--gray-100); }
    .btn-lg { padding: 12px 32px; font-size: 16px; }
    .form-actions { display: flex; gap: 12px; justify-content: flex-end; padding-top: 8px; }

    .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.7); z-index: 200; align-items: center; justify-content: center; }
    .loading-overlay.show { display: flex; }
    .spinner { width: 40px; height: 40px; border: 4px solid var(--gray-200); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .toast-container { position: fixed; top: 70px; right: 24px; z-index: 400; display: flex; flex-direction: column; gap: 8px; }
    .toast { background: #fff; border: 1px solid var(--gray-200); border-radius: var(--radius); padding: 12px 16px; box-shadow: var(--shadow-md); font-size: 14px; display: flex; align-items: center; gap: 8px; animation: slideIn 0.3s ease; max-width: 360px; }
    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--danger); }
    @keyframes slideIn { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }

    @media (max-width: 768px) {
      .navbar { padding: 0 12px; }
      .navbar-inner { flex-wrap: wrap; height: auto; padding: 8px 0; gap: 8px; }
      .navbar-nav { width: 100%; overflow-x: auto; }
      .container { padding: 16px; }
      .form-row { grid-template-columns: 1fr; }
      .timer-section { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>

<nav class="navbar">
  <div class="navbar-inner">
    <a href="index.html" class="navbar-brand"><span class="icon">ğŸ“</span>ãƒ†ãƒ¬ã‚¢ãƒé¡§å®¢ç®¡ç†</a>
    <ul class="navbar-nav">
      <li><a href="index.html">ğŸ  ãƒ›ãƒ¼ãƒ </a></li>
      <li><a href="#" id="navCustomers">ğŸ“‹ é¡§å®¢ä¸€è¦§</a></li>
      <li><a href="#" class="active" id="navCall">ğŸ“ æ¶é›»ç™»éŒ²</a></li>
      <li><a href="import.html">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</a></li>
      <li><a href="settings.html">âš™ï¸ è¨­å®š</a></li>
    </ul>
  </div>
</nav>

<div class="loading-overlay" id="loading"><div class="spinner"></div></div>
<div class="toast-container" id="toastContainer"></div>

<div class="container">
  <div class="breadcrumb">
    <a href="index.html">ãƒ›ãƒ¼ãƒ </a><span>â€º</span>
    <a href="#" id="bcBiz">æ¥­å‹™</a><span>â€º</span>
    <span>æ¶é›»ç™»éŒ²</span>
  </div>

  <div class="page-header">
    <h1>ğŸ“ æ¶é›»ç™»éŒ²</h1>
    <p>æ¶é›»çµæœã‚’è¨˜éŒ²ã—ã¾ã™</p>
  </div>

  <form id="callForm" onsubmit="return handleSubmit(event)">
    <!-- é¡§å®¢é¸æŠ -->
    <div class="card">
      <div class="card-header"><h2>ğŸ‘¤ é¡§å®¢ã‚’é¸æŠ</h2></div>
      <div class="card-body">
        <div class="form-group">
          <label>å¯¾è±¡é¡§å®¢<span class="required">*</span></label>
          <div class="customer-select-box">
            <input type="text" class="customer-search-input" id="customerSearch" placeholder="ä¼šç¤¾åãƒ»æ‹…å½“è€…åã§æ¤œç´¢..." autocomplete="off" oninput="handleCustomerSearch()" onfocus="handleCustomerSearch()">
            <div class="customer-dropdown" id="customerDropdown"></div>
          </div>
          <div class="selected-customer" id="selectedCustomer">
            <div class="sc-info"><span class="sc-name" id="scName"></span><span class="sc-detail" id="scDetail"></span></div>
            <button type="button" class="sc-remove" onclick="clearCustomer()">&times;</button>
          </div>
          <input type="hidden" id="selectedCustomerId" name="customerId" required>
        </div>
      </div>
    </div>

    <!-- é€šè©±ã‚¿ã‚¤ãƒãƒ¼ -->
    <div class="card">
      <div class="card-header"><h2>â±ï¸ é€šè©±ã‚¿ã‚¤ãƒãƒ¼</h2></div>
      <div class="card-body">
        <div class="timer-section">
          <div class="timer-display" id="timerDisplay">00:00</div>
          <div class="timer-buttons">
            <button type="button" class="btn btn-success" id="timerStart" onclick="startTimer()">â–¶ é–‹å§‹</button>
            <button type="button" class="btn btn-outline" id="timerStop" onclick="stopTimer()" style="display:none;">â¸ åœæ­¢</button>
            <button type="button" class="btn btn-outline" id="timerReset" onclick="resetTimer()">â†» ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </div>
        <input type="hidden" id="callDuration" name="duration">
      </div>
    </div>

    <!-- æ¶é›»çµæœï¼ˆè¤‡æ•°é¸æŠã‚¿ã‚°ï¼‰ -->
    <div class="card">
      <div class="card-header"><h2>ğŸ“ æ¶é›»çµæœ</h2></div>
      <div class="card-body">
        <div class="form-group">
          <label>æ¶é›»çµæœã‚¿ã‚°<span class="required">*</span>ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
          <div class="tag-buttons" id="tagButtons">
            <!-- JSã§æç”» -->
          </div>
          <div class="selected-tags-display" id="selectedTagsDisplay"></div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>æ¶é›»æ—¥æ™‚</label>
            <input type="datetime-local" id="callDate" name="callDate">
          </div>
          <div class="form-group">
            <label>å¯¾å¿œè€…<span class="required">*</span></label>
            <select id="operatorSelect" name="operator">
              <option value="">-- å¯¾å¿œè€…ã‚’é¸æŠ --</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>ãƒ¡ãƒ¢</label>
          <textarea name="memo" id="callMemo" placeholder="é€šè©±å†…å®¹ã‚„æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãªã©ã‚’è¨˜éŒ²..."></textarea>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <a href="#" class="btn btn-outline" id="cancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
      <button type="submit" class="btn btn-primary btn-lg">ğŸ’¾ æ¶é›»çµæœã‚’ç™»éŒ²</button>
    </div>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase-api.js"></script>
<script>
  // â”€â”€ èªè¨¼ãƒã‚§ãƒƒã‚¯ â”€â”€
  (function() {
    const a = JSON.parse(localStorage.getItem('authSession') || 'null');
    if (!a || Date.now() > a.expiry) { localStorage.removeItem('authSession'); location.replace('login.html'); }
  })();

  const FIXED_LEFT = 'ã‚¢ãƒç²å¾—';
  const FIXED_RIGHT = 'æ¥­ç¨®ä¸ä¸€è‡´';

  let customers = [];
  let selectedCustomer = null;
  let timerInterval = null;
  let timerSeconds = 0;
  let timerRunning = false;
  let businessId = '';
  let selectedTags = new Set();

  document.addEventListener('DOMContentLoaded', () => {
    const p = new URLSearchParams(window.location.search);
    businessId = p.get('businessId') || '';
    if (!businessId) { window.location.href = 'index.html'; return; }

    updateNavLinks();
    renderTagButtons();
    populateOperators();

    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('callDate').value = now.toISOString().slice(0, 16);

    loadCustomers();
  });

  function updateNavLinks() {
    const biz = encodeURIComponent(businessId);
    document.getElementById('navCustomers').href = `customers.html?businessId=${biz}`;
    document.getElementById('navCall').href = `call.html?businessId=${biz}`;
    document.getElementById('bcBiz').href = `customers.html?businessId=${biz}`;
    document.getElementById('cancelBtn').href = `customers.html?businessId=${biz}`;
    const businesses = JSON.parse(localStorage.getItem('businesses') || '[]');
    const b = businesses.find(x => x.id === businessId);
    if (b) document.getElementById('bcBiz').textContent = b.name;
  }

  // â”€â”€ æ¶é›»çµæœã‚¿ã‚°ï¼ˆè¤‡æ•°é¸æŠãƒ»æ¥­å‹™åˆ¥ï¼‰ â”€â”€
  function renderTagButtons() {
    const tagsByBiz = JSON.parse(localStorage.getItem('callResultTagsByBusiness') || '{}');
    const middleTags = tagsByBiz[businessId] || ['æ‹…å½“è€…ä¸åœ¨', 'ä¸åœ¨', 'å†æ¶é›»', 'è³‡æ–™é€ä»˜', 'æ–­ã‚Š'];
    const allTags = [FIXED_LEFT, ...middleTags, FIXED_RIGHT];
    const container = document.getElementById('tagButtons');

    container.innerHTML = allTags.map((tag, i) => {
      let cls = 'tag-btn';
      if (i === 0) cls += ' tag-first';
      if (i === allTags.length - 1) cls += ' tag-last';
      return `<button type="button" class="${cls}" data-tag="${esc(tag)}" onclick="toggleTag(this)">${esc(tag)}</button>`;
    }).join('');
  }

  function toggleTag(btn) {
    const tag = btn.dataset.tag;
    if (selectedTags.has(tag)) {
      selectedTags.delete(tag);
      btn.classList.remove('selected');
    } else {
      selectedTags.add(tag);
      btn.classList.add('selected');
    }
    updateTagsDisplay();
  }

  function updateTagsDisplay() {
    const display = document.getElementById('selectedTagsDisplay');
    if (selectedTags.size === 0) {
      display.textContent = '';
    } else {
      display.textContent = `é¸æŠä¸­: ${[...selectedTags].join('ã€')}`;
    }
  }

  // â”€â”€ å¯¾å¿œè€…ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ â”€â”€
  function populateOperators() {
    const operators = JSON.parse(localStorage.getItem('operators') || '[]');
    const sel = document.getElementById('operatorSelect');

    const filtered = operators.filter(op => {
      if (!op.businessIds || op.businessIds.length === 0) return true;
      return op.businessIds.includes(businessId);
    });

    sel.innerHTML = '<option value="">-- å¯¾å¿œè€…ã‚’é¸æŠ --</option>' +
      filtered.map(op => `<option value="${esc(op.name)}" data-id="${op.id}">${esc(op.name)}</option>`).join('');

    const lastOpId = localStorage.getItem('lastOperatorId');
    if (lastOpId) {
      const opt = sel.querySelector(`option[data-id="${lastOpId}"]`);
      if (opt) opt.selected = true;
    }
  }

  // â”€â”€ é¡§å®¢ â”€â”€
  async function loadCustomers() {
    try {
      const data = await apiGetCustomers(businessId);
      customers = data.customers || [];
      const preselect = new URLSearchParams(window.location.search).get('customerId');
      if (preselect) { const c = customers.find(x => x.id === preselect); if (c) selectCustomer(c); }
    } catch(e) { console.error('[loadCustomers]', e); }
  }

  function handleCustomerSearch() {
    const query = document.getElementById('customerSearch').value.toLowerCase().trim();
    const dropdown = document.getElementById('customerDropdown');
    if (!query || customers.length === 0) { dropdown.classList.remove('show'); return; }
    const matches = customers.filter(c => (c.companyName || '').toLowerCase().includes(query) || (c.contactName || '').toLowerCase().includes(query)).slice(0, 20);
    if (matches.length === 0) {
      dropdown.innerHTML = '<div style="padding:12px;color:var(--gray-400);font-size:14px;text-align:center;">è©²å½“ãªã—</div>';
    } else {
      dropdown.innerHTML = matches.map(c => `<div class="customer-option" onclick='selectCustomer(${JSON.stringify(c).replace(/'/g, "&#39;")})'><div><div class="co-name">${esc(c.companyName)}</div><div class="co-sub">${esc(c.contactName || '')} ${esc(c.phone || '')}</div></div></div>`).join('');
    }
    dropdown.classList.add('show');
  }

  function selectCustomer(c) {
    selectedCustomer = c;
    document.getElementById('selectedCustomerId').value = c.id;
    document.getElementById('scName').textContent = c.companyName;
    document.getElementById('scDetail').textContent = `${c.contactName || '-'} / ${c.phone || '-'}`;
    document.getElementById('selectedCustomer').classList.add('show');
    document.getElementById('customerSearch').style.display = 'none';
    document.getElementById('customerDropdown').classList.remove('show');
  }

  function clearCustomer() {
    selectedCustomer = null;
    document.getElementById('selectedCustomerId').value = '';
    document.getElementById('selectedCustomer').classList.remove('show');
    document.getElementById('customerSearch').style.display = '';
    document.getElementById('customerSearch').value = '';
  }

  // â”€â”€ ã‚¿ã‚¤ãƒãƒ¼ â”€â”€
  function startTimer() {
    if (timerRunning) return;
    timerRunning = true;
    document.getElementById('timerDisplay').classList.add('active');
    document.getElementById('timerStart').style.display = 'none';
    document.getElementById('timerStop').style.display = '';
    timerInterval = setInterval(() => { timerSeconds++; updateTimerDisplay(); }, 1000);
  }
  function stopTimer() {
    timerRunning = false; clearInterval(timerInterval);
    document.getElementById('timerDisplay').classList.remove('active');
    document.getElementById('timerStart').style.display = '';
    document.getElementById('timerStop').style.display = 'none';
    document.getElementById('callDuration').value = formatTimer(timerSeconds);
  }
  function resetTimer() { stopTimer(); timerSeconds = 0; updateTimerDisplay(); document.getElementById('callDuration').value = ''; }
  function updateTimerDisplay() { document.getElementById('timerDisplay').textContent = formatTimer(timerSeconds); }
  function formatTimer(sec) { return `${String(Math.floor(sec / 60)).padStart(2, '0')}:${String(sec % 60).padStart(2, '0')}`; }

  // â”€â”€ é€ä¿¡ â”€â”€
  async function handleSubmit(event) {
    event.preventDefault();
    const customerId = document.getElementById('selectedCustomerId').value;
    if (!customerId) { showToast('é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return false; }
    if (selectedTags.size === 0) { showToast('æ¶é›»çµæœã‚¿ã‚°ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„', 'error'); return false; }

    const sel = document.getElementById('operatorSelect');
    if (!sel.value) { showToast('å¯¾å¿œè€…ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return false; }

    if (timerRunning) stopTimer();

    const selectedOpt = sel.selectedOptions[0];
    if (selectedOpt && selectedOpt.dataset.id) localStorage.setItem('lastOperatorId', selectedOpt.dataset.id);

    showLoading(true);
    try {
      await apiAddCallRecord({
        customerId,
        callDate:  document.getElementById('callDate').value,
        result:    [...selectedTags].join(','),
        duration:  document.getElementById('callDuration').value || formatTimer(timerSeconds),
        operator:  sel.value,
        memo:      document.getElementById('callMemo').value.trim(),
      });
      showToast('æ¶é›»çµæœã‚’ç™»éŒ²ã—ã¾ã—ãŸ âœ…', 'success');
      setTimeout(() => {
        window.location.href = `detail.html?id=${encodeURIComponent(customerId)}&businessId=${encodeURIComponent(businessId)}`;
      }, 1000);
    } catch(e) {
      console.error('[handleSubmit]', e);
      showToast('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e.message || String(e)), 'error');
    } finally { showLoading(false); }
    return false;
  }

  function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
  function showLoading(v) { document.getElementById('loading').classList.toggle('show', v); }
  function showToast(msg, type = 'success') {
    const c = document.getElementById('toastContainer'); const t = document.createElement('div'); t.className = `toast ${type}`;
    t.innerHTML = `<span>${type==='success'?'âœ…':'âŒ'}</span> ${esc(msg)}`;
    c.appendChild(t); setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(() => t.remove(), 300); }, 4000);
  }
  document.addEventListener('click', e => { if (!e.target.closest('.customer-select-box')) document.getElementById('customerDropdown').classList.remove('show'); });
</script>

</body>
</html>
